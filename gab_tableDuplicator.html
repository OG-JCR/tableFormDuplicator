<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Duplicator - GAB Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            color: #333333;
            line-height: 1.6;
        }

        /* Header Styles */
        .header {
            background: #ffffff;
            color: #333333;
            padding: 30px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid #2c5aa0;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }

        .logo {
            max-width: 180px;
            margin-bottom: 15px;
            background: #ffffff;
            padding: 12px 20px;
            border-radius: 8px;
        }

        .header-title {
            font-size: 28px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            color: #2c5aa0;
        }

        .header-subtitle {
            font-size: 16px;
            color: #666666;
            font-weight: 300;
        }

        /* Button styles */
        .btn-primary {
            background: #2c5aa0;
            color: #ffffff;
            border-color: #2c5aa0;
        }

        .btn-primary:hover {
            background: #234780;
            border-color: #234780;
        }

        .btn-success {
            background: #4b3fff;
            color: #ffffff;
            border-color: #4b3fff;
        }

        .btn-success:hover {
            background: #3d32e6;
            border-color: #3d32e6;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Mode Toggle Styles */
        .form-check-input:checked {
            background-color: #2c5aa0;
            border-color: #2c5aa0;
        }

        .form-check-input:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 0.25rem rgba(44, 90, 160, 0.25);
        }

        #apiTestSection {
            display: none;
        }

        /* DataTable Styles */
        .editable-field {
            width: 100%;
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #ffffff;
            cursor: text;
            display: block;
            transition: all 0.2s;
        }

        .editable-field:hover {
            border-color: #2c5aa0;
            background-color: #f8f9fa;
        }

        .editable-field:focus-within {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .editable-field.editing {
            background-color: #ffffff;
            border-color: #2c5aa0;
        }

        .field-input {
            width: 100%;
            padding: 6px 12px;
            border: 1px solid #2c5aa0;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .field-input:focus {
            outline: none;
            border-color: #1e3a6f;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .field-type-badge {
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
        }

        #fieldsTable tbody tr {
            cursor: default;
        }

        #fieldsTable tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Remove special highlighting for New Name column */
        #fieldsTable thead th:nth-child(2) {
            font-weight: 600;
        }

        /* Field Type Dropdown - Make it cleaner and wider */
        .field-type-select {
            width: 100%;
            border: 1px solid #ced4da;
            transition: all 0.2s;
            padding: 6px 12px;
            background-color: #ffffff;
        }

        .field-type-select:hover {
            border-color: #2c5aa0;
        }

        .field-type-select:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        /* Adjust table cell padding for better spacing */
        #fieldsTable tbody td {
            vertical-align: middle;
            padding: 12px 8px;
        }

        /* Forms List Styling */
        #formsListContainer .list-group-item {
            border-left: 3px solid #2c5aa0;
            transition: all 0.2s;
        }

        #formsListContainer .list-group-item:hover {
            background-color: #f8f9fa;
            border-left-color: #1e3a6f;
            transform: translateX(2px);
        }
        
        /* Form selection checkbox styling */
        .form-selection-checkbox {
            cursor: pointer;
            width: 1.25rem;
            height: 1.25rem;
            margin-top: 0.15rem;
        }
        
        .form-selection-checkbox:checked {
            background-color: #2c5aa0;
            border-color: #2c5aa0;
        }
        
        #formsListContainer .list-group-item:has(.form-selection-checkbox:checked) {
            background-color: #e7f3ff;
            border-left-color: #0d6efd;
        }

        .view-form-structure-btn {
            white-space: nowrap;
        }

        .view-form-structure-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(44, 90, 160, 0.2);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">Table Duplicator</h1>
            <p class="header-subtitle">Duplicate table structures with ease</p>
            
            <!-- Mode Toggle -->
            <div class="mt-3">
                <div class="form-check form-switch d-inline-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" id="technicalModeToggle" style="width: 3em; height: 1.5em; cursor: pointer;">
                    <label class="form-check-label" for="technicalModeToggle" style="cursor: pointer; font-size: 0.9rem;">
                        <span id="modeLabel">Technical Mode (API Testers Visible)</span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container-fluid px-4 py-4" style="background-color: #f8f9fa; min-height: 100vh; max-width: 1400px; margin: 0 auto;">
        
        <!-- API Test Section (Technical Mode Only) -->
        <div id="apiTestSection">
        <div class="bg-white rounded shadow-sm p-4 mb-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-bottom-0 py-3">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background-color: #28a745;">
                            <i class="bi bi-code-slash text-white fs-5"></i>
                        </div>
                        <h2 class="card-title mb-0 h4 text-dark">API Endpoint Testers</h2>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-link-45deg me-2"></i>Endpoint
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">GET</span>
                            <input type="text" class="form-control bg-light" value="/api/Application/getall" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-search me-2"></i>Search By
                        </label>
                        <div class="btn-group w-100 mb-2" role="group">
                            <input type="radio" class="btn-check" name="searchType" id="searchByKey" value="key" checked>
                            <label class="btn btn-outline-primary" for="searchByKey">App Key</label>
                            
                            <input type="radio" class="btn-check" name="searchType" id="searchById" value="id">
                            <label class="btn btn-outline-primary" for="searchById">App ID</label>
                        </div>
                    </div>

                    <div class="mb-3" id="appKeyInputContainer">
                        <label for="appKeyInput" class="form-label fw-semibold">
                            <i class="bi bi-key me-2"></i>Application Key
                        </label>
                        <input type="text" class="form-control" id="appKeyInput" placeholder="e.g., pirn7jja1" value="pirn7jja1">
                        <div class="form-text">Enter the Application Key (found in the URL)</div>
                    </div>

                    <div class="mb-3 hidden" id="appIdInputContainer">
                        <label for="appIdInput" class="form-label fw-semibold">
                            <i class="bi bi-hash me-2"></i>Application ID
                        </label>
                        <input type="number" class="form-control" id="appIdInput" placeholder="e.g., 1099" value="1099">
                        <div class="form-text">Enter the Application ID to test</div>
                    </div>

                    <button type="button" class="btn btn-success" id="testEndpointBtn">
                        <i class="bi bi-play-circle me-1"></i>
                        Test Endpoint
                    </button>

                    <!-- Response Section -->
                    <div id="apiResponseSection" class="mt-4 hidden">
                        <hr>
                        <h6 class="mb-3">
                            <i class="bi bi-terminal me-2"></i>API Response
                        </h6>
                        <div class="alert alert-light border">
                            <div class="mb-2">
                                <small class="text-muted">Status:</small>
                                <span id="responseStatus" class="badge bg-success ms-2">200 OK</span>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-2">Response Body:</small>
                                <pre id="responseBody" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Table Endpoint Test -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-table me-2"></i>Test: Get Application Tables
                    </h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-link-45deg me-2"></i>Endpoint
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">GET</span>
                            <input type="text" class="form-control bg-light" value="/api/applicationtable/getbyapplicationid" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="appTableKeyInput" class="form-label fw-semibold">
                            <i class="bi bi-key me-2"></i>Application Key
                        </label>
                        <input type="text" class="form-control" id="appTableKeyInput" placeholder="e.g., pirn7jja1" value="pirn7jja1">
                        <div class="form-text">Enter the Application Key to get its tables</div>
                    </div>

                    <button type="button" class="btn btn-success" id="testAppTableBtn">
                        <i class="bi bi-play-circle me-1"></i>
                        Get Tables
                    </button>

                    <!-- Response Section -->
                    <div id="appTableResponseSection" class="mt-4 hidden">
                        <hr>
                        <h6 class="mb-3">
                            <i class="bi bi-terminal me-2"></i>API Response
                        </h6>
                        <div class="alert alert-light border">
                            <div class="mb-2">
                                <small class="text-muted">Status:</small>
                                <span id="appTableResponseStatus" class="badge bg-success ms-2">200 OK</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Tables Found:</small>
                                <span id="appTableCount" class="badge bg-info ms-2">0</span>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-2">Response Body:</small>
                                <pre id="appTableResponseBody" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Get Fields by Table ID Endpoint Test -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-list-ul me-2"></i>Test: Get Table Fields
                    </h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-link-45deg me-2"></i>Endpoint
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">GET</span>
                            <input type="text" class="form-control bg-light" value="/api/Field/getbytableid" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tableKeyInput" class="form-label fw-semibold">
                            <i class="bi bi-key me-2"></i>Table Key
                        </label>
                        <input type="text" class="form-control" id="tableKeyInput" placeholder="e.g., h0eoy5gq8" value="">
                        <div class="form-text">Enter the Table Key to get its fields</div>
                    </div>

                    <button type="button" class="btn btn-success" id="testTableFieldsBtn">
                        <i class="bi bi-play-circle me-1"></i>
                        Get Fields
                    </button>

                    <!-- Response Section -->
                    <div id="tableFieldsResponseSection" class="mt-4 hidden">
                        <hr>
                        <h6 class="mb-3">
                            <i class="bi bi-terminal me-2"></i>API Response
                        </h6>
                        <div class="alert alert-light border">
                            <div class="mb-2">
                                <small class="text-muted">Status:</small>
                                <span id="tableFieldsResponseStatus" class="badge bg-success ms-2">200 OK</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Fields Found:</small>
                                <span id="tableFieldsCount" class="badge bg-info ms-2">0</span>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-2">Response Body:</small>
                                <pre id="tableFieldsResponseBody" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Field Endpoint Test -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-plus-square me-2"></i>Test: Create Field
                    </h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-link-45deg me-2"></i>Endpoint
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">POST</span>
                            <input type="text" class="form-control bg-light" value="/api/Field" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="createFieldTableKey" class="form-label fw-semibold">
                            <i class="bi bi-key me-2"></i>Target Table Key
                        </label>
                        <input type="text" class="form-control" id="createFieldTableKey" placeholder="e.g., okm4nz5a4">
                        <div class="form-text">Enter the Table Key where the field will be created</div>
                    </div>

                    <div class="mb-3">
                        <label for="createFieldPayload" class="form-label fw-semibold">
                            <i class="bi bi-code-square me-2"></i>Field Payload (JSON)
                        </label>
                        <textarea class="form-control font-monospace" id="createFieldPayload" rows="12" style="font-size: 0.85rem;"></textarea>
                        <div class="form-text">Edit the JSON payload to create a field</div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" id="loadSampleFieldBtn">
                            <i class="bi bi-file-earmark-code me-1"></i>
                            Load Sample
                        </button>
                        <button type="button" class="btn btn-success" id="testCreateFieldBtn">
                            <i class="bi bi-play-circle me-1"></i>
                            Create Field
                        </button>
                    </div>

                    <!-- Response Section -->
                    <div id="createFieldResponseSection" class="mt-4 hidden">
                        <hr>
                        <h6 class="mb-3">
                            <i class="bi bi-terminal me-2"></i>API Response
                        </h6>
                        <div class="alert alert-light border">
                            <div class="mb-2">
                                <small class="text-muted">Status:</small>
                                <span id="createFieldResponseStatus" class="badge bg-success ms-2">200 OK</span>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-2">Response Body:</small>
                                <pre id="createFieldResponseBody" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End API Test Section -->

        <!-- Main Duplicator Section -->
        <div class="bg-white rounded shadow-sm p-4">
            <!-- Form Section -->
            <div id="formSection">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom-0 py-3">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background-color: #2c5aa0;">
                                <i class="bi bi-copy text-white fs-5"></i>
                            </div>
                            <h2 class="card-title mb-0 h4 text-dark">Duplicate Table Structure</h2>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <form id="tableForm">
                            <div class="row g-3">
                                <!-- SOURCE SECTION -->
                                <div class="col-12">
                                    <h5 class="mb-3 pb-2 border-bottom">
                                        <i class="bi bi-box-arrow-up-right me-2"></i>Source Table
                                    </h5>
                                </div>

                                <!-- Source Application Key -->
                                <div class="col-12">
                                    <label for="sourceAppKey" class="form-label fw-semibold">
                                        <i class="bi bi-app-indicator me-2"></i>Source Application Key
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="sourceAppKey" required placeholder="e.g., pirn7jja1">
                                        <button class="btn btn-outline-secondary" type="button" id="loadSourceTablesBtn">
                                            <i class="bi bi-search me-1"></i>Load Tables
                                        </button>
                                    </div>
                                    <div class="form-text">Enter the Application Key to copy table structure from</div>
                                </div>

                                <!-- Source Table Dropdown -->
                                <div class="col-12">
                                    <label for="sourceTableDropdown" class="form-label fw-semibold">
                                        <i class="bi bi-table me-2"></i>Source Table
                                        <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="sourceTableDropdown" required disabled>
                                        <option value="">-- Load tables first --</option>
                                    </select>
                                    <div class="form-text">Select the table to copy fields from</div>
                                </div>

                                <!-- Fields Preview Table -->
                                <div class="col-12" id="fieldsPreviewContainer" style="display: none;">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-list-check me-2"></i>Fields to Duplicate
                                                <span class="badge bg-primary ms-2" id="fieldsCount">0</span>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Edit field names and types directly in the table before duplicating.
                                            </small>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table id="fieldsTable" class="table table-hover mb-0" style="width:100%">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th style="width: 25%;">Original Name</th>
                                                            <th style="width: 30%;">New Name</th>
                                                            <th style="width: 20%;">Field Type</th>
                                                            <th style="width: 25%;">Details</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- FORMS SECTION -->
                                <div class="col-12 mt-4" id="formsPreviewContainer" style="display: none;">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">
                                                <i class="bi bi-file-earmark-text me-2"></i>Forms Available in Source Table
                                                <span class="badge bg-info ms-2" id="formsCount">0</span>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                These forms are associated with the source table. You can review their structure in the next step.
                                            </small>
                                        </div>
                                        <div class="card-body">
                                            <div id="formsListContainer">
                                                <!-- Forms will be displayed here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- DESTINATION SECTION -->
                                <div class="col-12 mt-4">
                                    <h5 class="mb-3 pb-2 border-bottom">
                                        <i class="bi bi-box-arrow-in-down me-2"></i>Destination
                                    </h5>
                                </div>

                                <!-- Destination Application Key -->
                                <div class="col-12">
                                    <label for="destAppKey" class="form-label fw-semibold">
                                        <i class="bi bi-app-indicator me-2"></i>Destination Application Key
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="destAppKey" required placeholder="e.g., pirn7jja1">
                                        <button class="btn btn-outline-secondary" type="button" id="lookupDestAppBtn">
                                            <i class="bi bi-search me-1"></i>Lookup
                                        </button>
                                    </div>
                                    <div class="form-text">Enter the Application Key where the new table will be created (can be same or different)</div>
                                    
                                    <!-- Destination App Details Display -->
                                    <div id="destAppDetailsContainer" class="mt-2 hidden">
                                        <div class="alert alert-success mb-0">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-check-circle-fill me-2"></i>
                                                <div>
                                                    <strong id="destAppDetailsName">App Name</strong>
                                                    <div class="small">
                                                        <span class="text-muted">App ID:</span> <strong id="destAppDetailsId">-</strong>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- New Table Name -->
                                <div class="col-12">
                                    <label for="tableName" class="form-label fw-semibold">
                                        <i class="bi bi-table me-2"></i>New Table Name
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="tableName" required placeholder="e.g., My New Table">
                                    <div class="form-text">Enter the name for your new table</div>
                                </div>

                                <!-- Singular Name -->
                                <div class="col-12">
                                    <label for="singularName" class="form-label fw-semibold">
                                        <i class="bi bi-tag me-2"></i>Singular Name
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="singularName" required placeholder="e.g., Record">
                                    <div class="form-text">Enter the singular name for records in this table</div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-success btn-lg" id="duplicateTableBtn" disabled>
                        <i class="bi bi-copy me-1"></i>
                        Duplicate Table
                    </button>
                </div>
            </div>

            <!-- Loading Section -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Processing your request...</p>
            </div>

            <!-- Success Section -->
            <div id="successSection" class="hidden">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4 text-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px; background-color: rgba(44, 90, 160, 0.1);">
                            <i class="bi bi-check-circle-fill" style="font-size: 2.5rem; color: #2c5aa0;"></i>
                        </div>
                        <h4 class="mb-2" style="color: #2c5aa0;">Table Created Successfully!</h4>
                        <p class="text-muted mb-4">Your new table has been created.</p>
                        
                        <div id="successDetails" class="text-start mb-4">
                            <!-- Will be populated with success details -->
                        </div>

                        <button type="button" class="btn btn-primary" id="createAnotherBtn">
                            <i class="bi bi-plus-circle me-1"></i>
                            Duplicate Another Table
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
        // API Configuration
        const aesKEY = "UjXn2r5u8x!A%D*G-KaPdSgVkYp3s6v9";
        const SERVER_URL_PAGE = "https://api.ignatius.io";

        // User Authentication
        let userToken = '';
        try {
            const encryptedToken = localStorage.getItem("token");
            if (encryptedToken) {
                userToken = CryptoJS.AES.decrypt(encryptedToken, aesKEY).toString(CryptoJS.enc.Utf8);
                console.log('User token decrypted successfully');
            } else {
                console.warn('No token found in localStorage');
            }
        } catch (error) {
            console.error("Error decrypting token:", error);
        }

        // Global variables for table duplication
        let sourceAppKey = null;
        let sourceTableKey = null;
        let sourceTableName = null;
        let sourceFields = [];
        let customFieldsToDuplicate = []; // Store filtered fields that will actually be duplicated
        let fieldsDataTable = null;
        let fieldNameMappings = {}; // Store original -> new name mappings
        let fieldTypeMappings = {}; // Store original -> new type mappings
        let selectedFormsForDuplication = []; // Store selected forms to duplicate
        let fieldKeyMapping = {}; // Maps source field keys to new field keys: {sourceKey: newKey}
        let sourceForms = []; // Store all forms from source table
        
        let destAppId = null;
        let destAppKey = null;
        let destAppName = null;

        // Field Type Mapping - Maps API FieldType to Display Name and back
        const fieldTypeMap = {
            // Text/String Types
            'VARCHAR': { display: 'Text (Short)', apiType: 'VARCHAR', description: 'Short text field' },
            'VARCHAR(255)': { display: 'Text (Short)', apiType: 'VARCHAR(255)', description: 'Short text field (255 chars)' },
            'TEXT': { display: 'Text (Long)', apiType: 'TEXT', description: 'Long text field' },
            'LONGTEXT': { display: 'Text (Very Long)', apiType: 'LONGTEXT', description: 'Very long text field' },
            
            // Number Types
            'INT': { display: 'Number (Integer)', apiType: 'INT', description: 'Whole numbers only' },
            'DOUBLE': { display: 'Number (Decimal)', apiType: 'DOUBLE', description: 'Numbers with decimals' },
            'DECIMAL': { display: 'Number (Precise)', apiType: 'DECIMAL', description: 'Precise decimal numbers' },
            
            // Boolean/Checkbox
            'TINYINT(1)': { display: 'Checkbox', apiType: 'TINYINT(1)', description: 'True/False checkbox' },
            'BOOLEAN': { display: 'Checkbox', apiType: 'TINYINT(1)', description: 'True/False checkbox' },
            
            // Date/Time Types
            'DATE': { display: 'Date', apiType: 'DATE', description: 'Date only' },
            'DATETIME': { display: 'Date & Time', apiType: 'DATETIME', description: 'Date and time' },
            'TIMESTAMP': { display: 'Timestamp', apiType: 'TIMESTAMP', description: 'Date and time stamp' },
            
            // Selection Types
            'ENUM': { display: 'Dropdown', apiType: 'ENUM', description: 'Single selection dropdown' },
            
            // Special Types
            'USER': { display: 'User', apiType: 'USER', description: 'User selection' },
            'EMAIL': { display: 'Email', apiType: 'EMAIL', description: 'Email address' },
            'PHONE': { display: 'Phone', apiType: 'PHONE', description: 'Phone number' },
            'URL': { display: 'URL', apiType: 'URL', description: 'Web address' },
            'FILE': { display: 'File Upload', apiType: 'FILE', description: 'File attachment' },
            'IMAGE': { display: 'Image Upload', apiType: 'IMAGE', description: 'Image file' }
        };

        // Get available field types for dropdown (excluding special types that shouldn't be converted)
        const editableFieldTypes = [
            { value: 'VARCHAR', label: 'Text (Short)' },
            { value: 'TEXT', label: 'Text (Long)' },
            { value: 'LONGTEXT', label: 'Text (Very Long)' },
            { value: 'INT', label: 'Number (Integer)' },
            { value: 'DOUBLE', label: 'Number (Decimal)' },
            { value: 'DECIMAL', label: 'Number (Precise)' },
            { value: 'TINYINT(1)', label: 'Checkbox' },
            { value: 'DATE', label: 'Date' },
            { value: 'DATETIME', label: 'Date & Time' },
            { value: 'ENUM', label: 'Dropdown' },
            { value: 'EMAIL', label: 'Email' },
            { value: 'PHONE', label: 'Phone' },
            { value: 'URL', label: 'URL' }
        ];

        /**
         * Get display name for field type
         */
        function getFieldTypeDisplay(fieldType) {
            return fieldTypeMap[fieldType]?.display || fieldType;
        }

        /**
         * Get API type from display name
         */
        function getFieldTypeAPI(displayOrApi) {
            // Check if it's already an API type
            if (fieldTypeMap[displayOrApi]) {
                return displayOrApi;
            }
            // Search for matching display name
            for (const [apiType, config] of Object.entries(fieldTypeMap)) {
                if (config.display === displayOrApi) {
                    return apiType;
                }
            }
            return displayOrApi; // Return as-is if not found
        }

        // Initialize on page load
        $(document).ready(function() {
            console.log('Table Duplicator - Initialized');
            
            // Initialize mode - default to User Mode (technical mode OFF)
            const savedMode = localStorage.getItem('tableDuplicatorTechnicalMode');
            if (savedMode === 'true') {
                $('#technicalModeToggle').prop('checked', true);
                showTechnicalMode();
            } else {
                $('#technicalModeToggle').prop('checked', false);
                hideTechnicalMode();
            }
            
            // Technical mode toggle handler
            $('#technicalModeToggle').on('change', function() {
                const isChecked = $(this).is(':checked');
                localStorage.setItem('tableDuplicatorTechnicalMode', isChecked);
                
                if (isChecked) {
                    showTechnicalMode();
                } else {
                    hideTechnicalMode();
                }
            });
            
            // Enable duplicate button when form is filled
            $('#tableForm input[required]').on('input', function() {
                validateDuplicateForm();
            });

            // Load source tables button handler
            $('#loadSourceTablesBtn').on('click', loadSourceTables);

            // Source table dropdown change handler
            $('#sourceTableDropdown').on('change', handleSourceTableSelection);

            // Lookup destination app button handler
            $('#lookupDestAppBtn').on('click', lookupDestinationApplication);

            // Duplicate table button handler
            $('#duplicateTableBtn').on('click', handleDuplicateTable);

            // Create another button handler
            $('#createAnotherBtn').on('click', resetForm);

            // App key input enter key handler
            $('#tableAppKey').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    lookupApplication();
                }
            });

            // Test endpoint button handler
            $('#testEndpointBtn').on('click', testGetAllEndpoint);

            // Test application table endpoint button handler
            $('#testAppTableBtn').on('click', testGetApplicationTable);

            // Test table fields endpoint button handler
            $('#testTableFieldsBtn').on('click', testGetTableFields);

            // Load sample field button handler
            $('#loadSampleFieldBtn').on('click', loadSampleFieldPayload);

            // Test create field endpoint button handler
            $('#testCreateFieldBtn').on('click', testCreateField);

            // Search type toggle handler
            $('input[name="searchType"]').on('change', function() {
                const searchType = $(this).val();
                if (searchType === 'key') {
                    $('#appKeyInputContainer').removeClass('hidden');
                    $('#appIdInputContainer').addClass('hidden');
                } else {
                    $('#appKeyInputContainer').addClass('hidden');
                    $('#appIdInputContainer').removeClass('hidden');
                }
            });
        });

        /**
         * Show technical mode (API testers)
         */
        function showTechnicalMode() {
            $('#apiTestSection').slideDown(300);
            $('#modeLabel').html('<i class="bi bi-code-slash me-1"></i>Technical Mode (API Testers Visible)');
            console.log('üîß Technical Mode: ON - API testers visible');
        }

        /**
         * Hide technical mode (API testers)
         */
        function hideTechnicalMode() {
            $('#apiTestSection').slideUp(300);
            $('#modeLabel').html('<i class="bi bi-person me-1"></i>User Mode (Clean Interface)');
            console.log('üë§ User Mode: ON - API testers hidden');
        }

        /**
         * Load source tables
         */
        function loadSourceTables() {
            const appKey = $('#sourceAppKey').val().trim();
            
            if (!appKey) {
                alert('Please enter a Source Application Key');
                return;
            }

            console.log('üîç Loading tables for source app:', appKey);

            // Disable button and show loading state
            $('#loadSourceTablesBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Loading...');
            $('#sourceTableDropdown').prop('disabled', true).html('<option value="">Loading...</option>');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/applicationtable/getbyapplicationid',
                type: 'GET',
                data: { id: appKey },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Source tables loaded:', response);
                    
                    if (response && response.length > 0) {
                        sourceAppKey = appKey;
                        
                        // Populate dropdown
                        let options = '<option value="">-- Select a Table --</option>';
                        response.forEach(table => {
                            options += `<option value="${table.Key}" data-name="${table.Name}">${table.Name}</option>`;
                        });
                        
                        $('#sourceTableDropdown').html(options).prop('disabled', false);
                        console.log(`üìã Loaded ${response.length} tables`);
                    } else {
                        $('#sourceTableDropdown').html('<option value="">No tables found</option>');
                        console.warn('‚ö†Ô∏è No tables found in this app');
                    }
                    
                    // Re-enable button
                    $('#loadSourceTablesBtn').prop('disabled', false).html('<i class="bi bi-search me-1"></i>Load Tables');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading tables:', error);
                    alert('Failed to load tables: ' + error);
                    
                    $('#sourceTableDropdown').html('<option value="">Error loading tables</option>');
                    $('#loadSourceTablesBtn').prop('disabled', false).html('<i class="bi bi-search me-1"></i>Load Tables');
                }
            });
        }

        /**
         * Handle source table selection
         */
        function handleSourceTableSelection() {
            const selectedOption = $('#sourceTableDropdown option:selected');
            sourceTableKey = selectedOption.val();
            sourceTableName = selectedOption.data('name');
            
            if (sourceTableKey) {
                console.log('üìã Source table selected:', sourceTableName, '(Key:', sourceTableKey + ')');
                
                // Load fields for this table
                loadSourceTableFields(sourceTableKey);
                
                // Load forms for this table
                loadSourceTableForms(sourceTableKey);
            } else {
                sourceFields = [];
                $('#fieldsPreviewContainer').hide();
                $('#formsPreviewContainer').hide();
            }
            
            validateDuplicateForm();
        }

        /**
         * Load fields from source table
         */
        function loadSourceTableFields(tableKey) {
            console.log('üîç Loading fields for table:', tableKey);

            $.ajax({
                url: SERVER_URL_PAGE + '/api/Field/getbytableid',
                type: 'GET',
                data: { id: tableKey },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Fields loaded:', response);
                    
                    // Store all fields
                    sourceFields = response || [];
                    
                    // Filter out default fields, relationship fields, formula fields, and lookup fields
                    const defaultFields = ['id', 'datecreated', 'datemodified', 'createdby', 'modifiedby'];
                    const customFields = sourceFields.filter(field => {
                        // Skip default system fields
                        if (defaultFields.includes(field.FieldName)) {
                            return false;
                        }
                        
                        // Skip relationship fields (IsRelation flag, field name starts with "related_", or FieldType is "RELATIONSHIP")
                        if (field.IsRelation || field.FieldName.toLowerCase().startsWith('related_') || field.FieldType === 'RELATIONSHIP') {
                            return false;
                        }
                        
                        // Skip lookup fields (field name contains table reference like tbl9721_)
                        if (/tbl\d+_/.test(field.FieldName)) {
                            return false;
                        }
                        
                        // Skip formula fields
                        if (field.IsFormula) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    // Store globally for form comparison
                    customFieldsToDuplicate = customFields;
                    
                    const relationshipFields = sourceFields.filter(field => 
                        field.IsRelation || field.FieldName.toLowerCase().startsWith('related_') || field.FieldType === 'RELATIONSHIP'
                    );
                    
                    const lookupFields = sourceFields.filter(field => /tbl\d+_/.test(field.FieldName));
                    
                    const formulaFields = sourceFields.filter(field => field.IsFormula);
                    
                    console.log(`üìä Total fields: ${sourceFields.length}`);
                    console.log(`üìä Custom fields to duplicate: ${customFields.length}`);
                    
                    if (relationshipFields.length > 0) {
                        console.log(`üìä Relationship fields (will be skipped): ${relationshipFields.length}`);
                        relationshipFields.forEach(field => {
                            console.log(`   ‚è≠Ô∏è ${field.Name} (${field.FieldName}) - Type: ${field.FieldType}`);
                        });
                    }
                    
                    if (lookupFields.length > 0) {
                        console.log(`üìä Lookup fields (will be skipped): ${lookupFields.length}`);
                        lookupFields.forEach(field => {
                            console.log(`   ‚è≠Ô∏è ${field.Name} (${field.FieldName})`);
                        });
                    }
                    
                    if (formulaFields.length > 0) {
                        console.log(`üìä Formula fields (will be skipped): ${formulaFields.length}`);
                        formulaFields.forEach(field => {
                            console.log(`   ‚è≠Ô∏è ${field.Name} (${field.FieldName}) - Formula: ${field.Formula || 'N/A'}`);
                        });
                    }
                    
                    if (customFields.length > 0) {
                        console.log('üìã Custom fields:');
                        customFields.forEach((field, index) => {
                            console.log(`   ${index + 1}. ${field.Name} (${field.FieldType})`);
                        });
                    }
                    
                    // Display fields in DataTable
                    displayFieldsTable(customFields);
                    
                    validateDuplicateForm();
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading fields:', error);
                    sourceFields = [];
                }
            });
        }

        /**
         * Display fields in DataTable
         */
        function displayFieldsTable(customFields) {
            // Initialize field name and type mappings
            fieldNameMappings = {};
            fieldTypeMappings = {};
            customFields.forEach(field => {
                fieldNameMappings[field.FieldName] = field.Name; // Default to original name
                fieldTypeMappings[field.FieldName] = field.FieldType; // Default to original type
            });

            // Destroy existing DataTable if it exists
            if (fieldsDataTable) {
                fieldsDataTable.destroy();
            }

            // Show the container
            $('#fieldsPreviewContainer').slideDown(300);
            $('#fieldsCount').text(customFields.length);

            // Prepare data for DataTable
            const tableData = customFields.map(field => {
                let details = '';
                
                // Add enum values if present
                if (field.Values && field.Values.length > 0) {
                    const values = field.Values.map(v => v.Value).join(', ');
                    details = `<small class="text-muted">Values: ${values}</small>`;
                }
                
                // Add nullable/unique info
                const flags = [];
                if (field.IsUnique) flags.push('Unique');
                if (field.IsNullable) flags.push('Nullable');
                if (flags.length > 0) {
                    details += (details ? '<br>' : '') + `<small class="text-muted">${flags.join(', ')}</small>`;
                }

                // Create editable type dropdown
                const typeDisplay = getFieldTypeDisplay(field.FieldType);
                const typeDropdown = `
                    <select class="form-select form-select-sm field-type-select" data-field-name="${field.FieldName}" title="Change field type">
                        ${editableFieldTypes.map(type => 
                            `<option value="${type.value}" ${field.FieldType === type.value ? 'selected' : ''}>${type.label}</option>`
                        ).join('')}
                    </select>
                `;

                return [
                    field.Name, // Original name
                    `<input type="text" class="form-control form-control-sm editable-field" data-field-name="${field.FieldName}" value="${field.Name}" placeholder="Enter field name">`, // Editable input
                    typeDropdown, // Editable type dropdown
                    details || '-'
                ];
            });

            // Initialize DataTable
            fieldsDataTable = $('#fieldsTable').DataTable({
                data: tableData,
                pageLength: 10,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                order: [[0, 'asc']],
                language: {
                    search: "Search fields:",
                    lengthMenu: "Show _MENU_ fields",
                    info: "Showing _START_ to _END_ of _TOTAL_ fields",
                    infoEmpty: "No fields to display",
                    infoFiltered: "(filtered from _MAX_ total fields)"
                },
                columnDefs: [
                    { orderable: true, targets: [0, 1, 2] },
                    { orderable: false, targets: [3] }
                ]
            });

            // Add input handler for editable name fields
            $('#fieldsTable tbody').on('input', '.editable-field', function() {
                const $this = $(this);
                const fieldName = $this.data('field-name');
                const newName = $this.val().trim();
                
                if (newName && newName !== '') {
                    fieldNameMappings[fieldName] = newName;
                }
            });

            // Add blur handler to log changes
            $('#fieldsTable tbody').on('blur', '.editable-field', function() {
                const $this = $(this);
                const fieldName = $this.data('field-name');
                const newName = $this.val().trim();
                
                if (newName && newName !== '') {
                    console.log(`‚úèÔ∏è Field name updated: ${fieldName} ‚Üí ${newName}`);
                }
            });

            // Add change handler for field type dropdowns
            $('#fieldsTable tbody').on('change', '.field-type-select', function() {
                const $this = $(this);
                const fieldName = $this.data('field-name');
                const newType = $this.val();
                const newTypeLabel = $this.find('option:selected').text();
                
                // Update mapping
                fieldTypeMappings[fieldName] = newType;
                console.log(`üîÑ Changed field type for ${fieldName}: ${newTypeLabel} (${newType})`);
            });

            console.log('üìä Fields table displayed with', customFields.length, 'fields');
        }

        /**
         * Load forms from source table
         */
        function loadSourceTableForms(tableKey) {
            console.log('üîç Loading forms for table:', tableKey);

            $.ajax({
                url: SERVER_URL_PAGE + '/api/form/getbytableid',
                type: 'GET',
                data: { 
                    Id: tableKey,
                    inReport: false 
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Forms loaded:', response);
                    
                    const forms = response || [];
                    
                    if (forms.length > 0) {
                        console.log(`üìã Found ${forms.length} form(s) in source table`);
                        displayFormsList(forms);
                    } else {
                        console.log('üìã No forms found in source table');
                        $('#formsPreviewContainer').hide();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading forms:', error);
                    $('#formsPreviewContainer').hide();
                }
            });
        }

        /**
         * Display forms list
         */
        function displayFormsList(forms) {
            sourceForms = forms; // Store forms for later use
            $('#formsCount').text(forms.length);
            
            let formsHtml = '<div class="list-group">';
            
            forms.forEach((form, index) => {
                const isDefault = form.DefaultForm === 1;
                const tabCount = form.FormData ? form.FormData.filter(fd => fd.Type === 'tabtitle').length : 0;
                const formType = form.Type || 'web';
                
                formsHtml += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input form-selection-checkbox" 
                                       type="checkbox" 
                                       value="${form.Key}" 
                                       id="form-${form.Key}"
                                       data-form-name="${form.Name}">
                                <label class="form-check-label visually-hidden" for="form-${form.Key}">
                                    Select ${form.Name}
                                </label>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <i class="bi bi-file-earmark-text me-2 text-primary"></i>
                                    ${form.Name}
                                    ${isDefault ? '<span class="badge bg-primary ms-2">Default</span>' : ''}
                                </h6>
                                <div class="small text-muted">
                                    <span class="me-3">
                                        <i class="bi bi-key me-1"></i>
                                        <code>${form.Key}</code>
                                    </span>
                                    <span class="me-3">
                                        <i class="bi bi-laptop me-1"></i>
                                        ${formType}
                                    </span>
                                    ${tabCount > 0 ? `
                                        <span>
                                            <i class="bi bi-collection me-1"></i>
                                            ${tabCount} tab${tabCount !== 1 ? 's' : ''}
                                        </span>
                                    ` : ''}
                                </div>
                                ${form.Description ? `<p class="mb-0 mt-2 small">${form.Description}</p>` : ''}
                            </div>
                            <div class="ms-3">
                                <button class="btn btn-sm btn-outline-primary view-form-structure-btn" 
                                        data-form-key="${form.Key}" 
                                        data-form-name="${form.Name}"
                                        title="View Form Structure">
                                    <i class="bi bi-eye me-1"></i>
                                    View Structure
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            formsHtml += '</div>';
            
            $('#formsListContainer').html(formsHtml);
            $('#formsPreviewContainer').slideDown(300);
            
            // Add event handlers for checkboxes
            $('.form-selection-checkbox').on('change', function() {
                updateSelectedForms();
            });
            
            // Add event handlers for view structure buttons
            $('.view-form-structure-btn').on('click', function() {
                const formKey = $(this).data('form-key');
                const formName = $(this).data('form-name');
                viewFormStructure(formKey, formName);
            });
            
            console.log('üìä Forms list displayed with', forms.length, 'form(s)');
        }

        /**
         * Update selected forms array based on checkboxes
         */
        function updateSelectedForms() {
            selectedFormsForDuplication = [];
            
            $('.form-selection-checkbox:checked').each(function() {
                const formKey = $(this).val();
                const formName = $(this).data('form-name');
                selectedFormsForDuplication.push({
                    key: formKey,
                    name: formName
                });
            });
            
            console.log(`üìã Selected ${selectedFormsForDuplication.length} form(s) for duplication:`, selectedFormsForDuplication);
            
            // Update forms count badge
            const selectedCount = selectedFormsForDuplication.length;
            if (selectedCount > 0) {
                $('#formsCount').text(`${sourceForms.length} (${selectedCount} selected)`);
            } else {
                $('#formsCount').text(sourceForms.length);
            }
            
            // Validate form
            validateDuplicateForm();
        }

        /**
         * Helper function to check if a field should be excluded from duplication
         */
        function shouldExcludeField(field) {
            // Design elements (HTML, DIVIDER) should always be included
            if (field.IsStyleOption && (field.DbFieldType === 'HTML' || field.DbFieldType === 'DIVIDER')) {
                return { excluded: false, reason: null };
            }
            
            // First check: Is this field in the customFieldsToDuplicate list?
            // This catches fields from related tables or any fields not in the source table
            if (customFieldsToDuplicate.length > 0) {
                const fieldKey = field.FieldKey || field.Key;
                const fieldName = field.FieldName || field.Name;
                
                // Look for this field in customFieldsToDuplicate by Key or FieldName
                const existsInSourceTable = customFieldsToDuplicate.some(sourceField => {
                    return sourceField.Key === fieldKey || 
                           sourceField.FieldKey === fieldKey ||
                           sourceField.FieldName === fieldName ||
                           sourceField.Name === fieldName;
                });
                
                if (!existsInSourceTable) {
                    // Check if it's a system field (those are auto-created, so not in the list)
                    const defaultFields = ['id', 'datecreated', 'datemodified', 'createdby', 'modifiedby'];
                    const isSystemField = defaultFields.includes(fieldKey?.toLowerCase()) || 
                                         defaultFields.includes(fieldName?.toLowerCase());
                    
                    if (!isSystemField) {
                        return { excluded: true, reason: 'Not in Source Table (Related/External Field)' };
                    }
                }
            }
            
            // System fields
            const defaultFields = ['id', 'datecreated', 'datemodified', 'createdby', 'modifiedby'];
            if (defaultFields.includes(field.FieldKey?.toLowerCase()) || 
                defaultFields.includes(field.FieldName?.toLowerCase())) {
                return { excluded: true, reason: 'System Field' };
            }
            
            // Relationship fields
            if (field.IsRelation || 
                field.FieldName?.toLowerCase().startsWith('related_') || 
                field.FieldType === 'RELATIONSHIP' ||
                field.DbFieldType === 'RELATIONSHIP') {
                return { excluded: true, reason: 'Relationship Field' };
            }
            
            // Lookup fields (contains table reference like tbl9721_)
            if (/tbl\d+_/.test(field.FieldKey || field.FieldName || '')) {
                return { excluded: true, reason: 'Lookup Field' };
            }
            
            // Formula fields
            if (field.IsFormulaField || field.IsFormula) {
                return { excluded: true, reason: 'Formula Field' };
            }
            
            return { excluded: false, reason: null };
        }

        /**
         * View form structure (loads detailed form data)
         */
        function viewFormStructure(formKey, formName) {
            console.log('üîç Loading structure for form:', formName, '(Key:', formKey + ')');
            
            // Show loading in a modal or new section
            const modalHtml = `
                <div class="modal fade" id="formStructureModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    Form Structure Comparison: ${formName}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Loading form structure and generating comparison...</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#formStructureModal').remove();
            
            // Add modal to body
            $('body').append(modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('formStructureModal'));
            modal.show();
            
            // Fetch form structure
            $.ajax({
                url: SERVER_URL_PAGE + '/api/form/loadformtoedit',
                type: 'GET',
                data: { 
                    id: formKey,
                    tableId: sourceTableKey
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Form structure loaded:', response);
                    console.log(`üîç Comparing against ${customFieldsToDuplicate.length} source table fields`);
                    displayFormStructure(response, formName);
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading form structure:', error);
                    $('#formStructureModal .modal-body').html(`
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load form structure: ${error}
                        </div>
                    `);
                }
            });
        }

        /**
         * Display form structure in modal with comparison view
         */
        function displayFormStructure(formData, formName) {
            const tabCount = formData.TabData ? formData.TabData.length : 0;
            const headerFieldCount = formData.HeaderFields ? formData.HeaderFields.length : 0;
            const embeddedReportCount = formData.EmbeddedReports ? formData.EmbeddedReports.length : 0;
            
            // Count total fields and excluded fields
            let totalFields = headerFieldCount;
            let excludedFields = 0;
            let excludedFieldsList = [];
            
            if (formData.HeaderFields) {
                formData.HeaderFields.forEach(field => {
                    const exclusion = shouldExcludeField(field);
                    if (exclusion.excluded) {
                        excludedFields++;
                        excludedFieldsList.push({ name: field.Name, reason: exclusion.reason, location: 'Header' });
                    }
                });
            }
            
            if (formData.TabData) {
                formData.TabData.forEach(tab => {
                    if (tab.Columns) {
                        totalFields += tab.Columns.length;
                        tab.Columns.forEach(field => {
                            const exclusion = shouldExcludeField(field);
                            if (exclusion.excluded) {
                                excludedFields++;
                                excludedFieldsList.push({ name: field.Name, reason: exclusion.reason, location: tab.Title });
                            }
                        });
                    }
                });
            }
            
            const includedFields = totalFields - excludedFields;
            
            let structureHtml = `
                <!-- Comparison Summary Alert -->
                <div class="alert ${excludedFields > 0 ? 'alert-info border-info' : 'alert-success'} mb-4" style="${excludedFields > 0 ? 'background-color: #e8f4f8; border-width: 2px;' : ''}">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-${excludedFields > 0 ? 'info-circle-fill' : 'check-circle-fill'} me-2" style="font-size: 1.5rem; color: ${excludedFields > 0 ? '#0c5460' : ''};"></i>
                        <h6 class="mb-0" style="${excludedFields > 0 ? 'color: #0c5460;' : ''}">Field Duplication Summary</h6>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <div class="card bg-white border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="h3 text-primary mb-1">${totalFields}</div>
                                    <small class="text-muted">Total Fields in Form</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-white border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="h3 text-success mb-1">${includedFields}</div>
                                    <small class="text-muted">Will Be Duplicated</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-white border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="h3 text-danger mb-1">${excludedFields}</div>
                                    <small class="text-muted">Will Be Excluded</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${excludedFields > 0 ? `
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#excludedFieldsList" style="border-width: 2px;">
                                <i class="bi bi-eye me-1"></i>
                                View ${excludedFields} Excluded Field${excludedFields > 1 ? 's' : ''}
                            </button>
                            <div class="collapse mt-3" id="excludedFieldsList">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Field Name</th>
                                                <th>Reason</th>
                                                <th>Location</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${excludedFieldsList.map(field => `
                                                <tr>
                                                    <td><strong>${field.name}</strong></td>
                                                    <td><span class="badge bg-danger">${field.reason}</span></td>
                                                    <td>${field.location}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <p class="mb-0 mt-2">
                            <i class="bi bi-check-circle me-1"></i>
                            All fields in this form will be duplicated successfully!
                        </p>
                    `}
                </div>
                
                <div class="mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-info-circle me-2"></i>Form Overview
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="card border-primary" style="background-color: #f0f7ff;">
                                <div class="card-body text-center">
                                    <div class="display-6 text-primary">${tabCount}</div>
                                    <small class="text-muted fw-semibold">Tabs</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary" style="background-color: #f0f7ff;">
                                <div class="card-body text-center">
                                    <div class="display-6 text-primary">${headerFieldCount}</div>
                                    <small class="text-muted fw-semibold">Header Fields</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary" style="background-color: #f0f7ff;">
                                <div class="card-body text-center">
                                    <div class="display-6 text-primary">${embeddedReportCount}</div>
                                    <small class="text-muted fw-semibold">Embedded Reports</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary" style="background-color: #f0f7ff;">
                                <div class="card-body text-center">
                                    <div class="display-6 text-primary">${formData.Type || 'web'}</div>
                                    <small class="text-muted fw-semibold">Form Type</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Header Fields Section
            if (headerFieldCount > 0) {
                structureHtml += `
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-layout-text-window-reverse me-2"></i>Header Fields
                            <span class="badge bg-secondary ms-2">${headerFieldCount} total</span>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Status</th>
                                        <th>Field Name</th>
                                        <th>Field Type</th>
                                        <th>Display Position</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                formData.HeaderFields.forEach(field => {
                    const exclusion = shouldExcludeField(field);
                    const isExcluded = exclusion.excluded;
                    const rowClass = isExcluded ? 'table-danger' : '';
                    const statusIcon = isExcluded ? 
                        `<i class="bi bi-x-circle-fill text-danger" title="Will be excluded: ${exclusion.reason}"></i>` : 
                        `<i class="bi bi-check-circle-fill text-success" title="Will be duplicated"></i>`;
                    
                    // Check if this is a design element
                    const isDesignElement = field.IsStyleOption && (field.DbFieldType === 'HTML' || field.DbFieldType === 'DIVIDER');
                    const designBadge = isDesignElement ? ` <span class="badge bg-info">Design Element</span>` : '';
                    
                    structureHtml += `
                        <tr class="${rowClass}">
                            <td class="text-center">${statusIcon}</td>
                            <td><strong>${field.Name}</strong>${isExcluded ? ` <span class="badge bg-danger">${exclusion.reason}</span>` : designBadge}</td>
                            <td><code>${field.FieldType || field.DbFieldType}</code></td>
                            <td>Row ${field.DisplayRowIndex}, Col ${field.DisplayColumnIndex}</td>
                        </tr>
                    `;
                });
                
                structureHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Tabs Section
            if (tabCount > 0) {
                structureHtml += `
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-collection me-2"></i>Form Tabs & Fields (with Comparison)
                        </h6>
                        <div class="accordion" id="tabsAccordion">
                `;
                
                formData.TabData.forEach((tab, tabIndex) => {
                    const fieldCount = tab.Columns ? tab.Columns.length : 0;
                    let excludedCount = 0;
                    
                    // Count excluded fields in this tab
                    if (tab.Columns) {
                        tab.Columns.forEach(field => {
                            if (shouldExcludeField(field).excluded) {
                                excludedCount++;
                            }
                        });
                    }
                    
                    const includedCount = fieldCount - excludedCount;
                    const accordionId = `tab${tabIndex}`;
                    
                    structureHtml += `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${tabIndex > 0 ? 'collapsed' : ''}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#${accordionId}">
                                    <strong>Tab ${tabIndex + 1}: ${tab.Title}</strong>
                                    <span class="badge bg-primary ms-2">${fieldCount} total</span>
                                    ${excludedCount > 0 ? `
                                        <span class="badge bg-success ms-1">${includedCount} will be duplicated</span>
                                        <span class="badge bg-danger ms-1">${excludedCount} excluded</span>
                                    ` : `
                                        <span class="badge bg-success ms-1">All fields will be duplicated</span>
                                    `}
                                </button>
                            </h2>
                            <div id="${accordionId}" class="accordion-collapse collapse ${tabIndex === 0 ? 'show' : ''}" 
                                 data-bs-parent="#tabsAccordion">
                                <div class="accordion-body">
                    `;
                    
                    if (fieldCount > 0) {
                        structureHtml += `
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Status</th>
                                            <th>Field Name</th>
                                            <th>Type</th>
                                            <th>Position</th>
                                            <th>Settings</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        tab.Columns.forEach(field => {
                            const exclusion = shouldExcludeField(field);
                            const isExcluded = exclusion.excluded;
                            const rowClass = isExcluded ? 'table-danger' : '';
                            const statusIcon = isExcluded ? 
                                `<i class="bi bi-x-circle-fill text-danger" title="Will be excluded: ${exclusion.reason}"></i>` : 
                                `<i class="bi bi-check-circle-fill text-success" title="Will be duplicated"></i>`;
                            
                            const settings = field.FormFieldSetting || {};
                            const badges = [];
                            
                            // Check if this is a design element (HTML or DIVIDER)
                            const isDesignElement = field.IsStyleOption && (field.DbFieldType === 'HTML' || field.DbFieldType === 'DIVIDER');
                            
                            if (isDesignElement) {
                                const designType = field.DbFieldType === 'DIVIDER' ? 'Divider' : 'HTML';
                                badges.push(`<span class="badge bg-info">Design Element (${designType})</span>`);
                            }
                            
                            if (isExcluded) {
                                badges.push(`<span class="badge bg-danger">${exclusion.reason}</span>`);
                            }
                            if (settings.Required) badges.push('<span class="badge bg-danger">Required</span>');
                            if (settings.Hidden) badges.push('<span class="badge bg-secondary">Hidden</span>');
                            if (settings.Readonly) badges.push('<span class="badge bg-warning">Read-only</span>');
                            if (field.IsFormulaField) badges.push('<span class="badge bg-info">Formula</span>');
                            if (field.IsSummaryField) badges.push('<span class="badge bg-success">Summary</span>');
                            
                            structureHtml += `
                                <tr class="${rowClass}">
                                    <td class="text-center">${statusIcon}</td>
                                    <td><strong>${field.Name}</strong></td>
                                    <td><code>${field.DbFieldType || field.FieldType}</code></td>
                                    <td>Row ${field.DisplayRowIndex}, Col ${field.DisplayColumnIndex}</td>
                                    <td>${badges.join(' ') || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        structureHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        structureHtml += '<p class="text-muted mb-0">No fields in this tab</p>';
                    }
                    
                    structureHtml += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                structureHtml += `
                        </div>
                    </div>
                `;
            }
            
            // Embedded Reports Section
            if (embeddedReportCount > 0) {
                structureHtml += `
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-file-earmark-bar-graph me-2"></i>Embedded Reports
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order</th>
                                        <th>Report Key</th>
                                        <th>Table Key</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                formData.EmbeddedReports.forEach(report => {
                    structureHtml += `
                        <tr>
                            <td><strong>${report.Order}</strong></td>
                            <td><code>${report.ReportKey}</code></td>
                            <td><code>${report.TableKey}</code></td>
                        </tr>
                    `;
                });
                
                structureHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Legend for color coding
            structureHtml += `
                <div class="mb-4">
                    <h6 class="text-secondary mb-3">
                        <i class="bi bi-info-square me-2"></i>Legend
                    </h6>
                    <div class="card border-secondary">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        <span><strong>Green checkmark:</strong> Field will be duplicated</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                        <span><strong>Red X:</strong> Field will be excluded (see reason badge)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    <strong>Tip:</strong> Red highlighted rows indicate fields that won't be created in the new table. 
                                    Common reasons include: System Fields (automatically created), Relationship Fields (require other tables), 
                                    Formula Fields (may have dependencies), and Lookup Fields (reference external tables).
                                </small>
                            </div>
                            <div class="mt-2">
                                <small class="text-success">
                                    <i class="bi bi-check2-circle me-1"></i>
                                    <strong>Design Elements:</strong> HTML and Divider elements <span class="badge bg-info">Design Element</span> will always be duplicated as they don't depend on table fields.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Raw JSON Section (for technical mode)
            structureHtml += `
                <div class="mb-2">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#rawJsonCollapse">
                        <i class="bi bi-code-square me-1"></i>
                        View Raw JSON
                    </button>
                    <div class="collapse mt-2" id="rawJsonCollapse">
                        <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>${JSON.stringify(formData, null, 2)}</code></pre>
                    </div>
                </div>
            `;
            
            $('#formStructureModal .modal-body').html(structureHtml);
            
            console.log('üìä Form structure displayed successfully');
        }

        /**
         * Lookup destination application by key
         */
        function lookupDestinationApplication() {
            const appKey = $('#destAppKey').val().trim();
            
            if (!appKey) {
                alert('Please enter a Destination Application Key');
                return;
            }

            console.log('üîç Looking up destination application with key:', appKey);

            // Disable button and show loading state
            $('#lookupDestAppBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
            $('#destAppDetailsContainer').addClass('hidden');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/Application/getall',
                type: 'GET',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Applications retrieved');
                    
                    // Find the app with matching key
                    const app = response.find(a => a.Key === appKey);
                    
                    if (app) {
                        console.log('‚úÖ Found destination application:', app);
                        
                        // Store app details globally
                        destAppId = app.Id;
                        destAppKey = app.Key;
                        destAppName = app.Name;
                        
                        // Display app details
                        $('#destAppDetailsName').text(app.Name);
                        $('#destAppDetailsId').text(app.Id);
                        $('#destAppDetailsContainer').removeClass('hidden');
                        
                        console.log(`üìã Destination App ID ${destAppId} will be used for table creation`);
                        
                        // Validate form now that we have destination app ID
                        validateDuplicateForm();
                    } else {
                        console.warn('‚ö†Ô∏è No application found with key:', appKey);
                        alert(`No application found with key: ${appKey}`);
                        
                        // Clear stored values
                        destAppId = null;
                        destAppKey = null;
                        destAppName = null;
                    }
                    
                    // Re-enable button
                    $('#lookupDestAppBtn').prop('disabled', false).html('<i class="bi bi-search me-1"></i>Lookup');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error looking up application:', error);
                    alert('Failed to lookup application: ' + error);
                    
                    // Re-enable button
                    $('#lookupDestAppBtn').prop('disabled', false).html('<i class="bi bi-search me-1"></i>Lookup');
                }
            });
        }

        /**
         * Handle duplicate table - main orchestration function
         */
        async function handleDuplicateTable() {
            if (!validateDuplicateForm()) {
                return;
            }

            const tableName = $('#tableName').val().trim();
            const singularName = $('#singularName').val().trim();

            console.log('üöÄ Starting table duplication process...');
            console.log(`   Source: ${sourceTableName} (${sourceTableKey}) from app ${sourceAppKey}`);
            console.log(`   Destination: New table "${tableName}" in app ${destAppName} (ID: ${destAppId})`);

            // Show loading
            $('#formSection').hide();
            $('#loadingSpinner').show();

            try {
                // Step 1: Create new table
                console.log('üìù Step 1: Creating new table...');
                const newTable = await createTableInDestination(tableName, singularName);
                console.log('‚úÖ New table created:', newTable);
                console.log(`   Table ID: ${newTable.Id}`);
                console.log(`   Table Key: ${newTable.Key}`);

                // Step 2: Filter out default fields, relationship fields, formula fields, and lookup fields
                const defaultFields = ['id', 'datecreated', 'datemodified', 'createdby', 'modifiedby'];
                const customFields = sourceFields.filter(field => {
                    // Skip default system fields
                    if (defaultFields.includes(field.FieldName)) {
                        return false;
                    }
                    
                    // Skip relationship fields (IsRelation flag, field name starts with "related_", or FieldType is "RELATIONSHIP")
                    if (field.IsRelation || field.FieldName.toLowerCase().startsWith('related_') || field.FieldType === 'RELATIONSHIP') {
                        console.log(`   ‚è≠Ô∏è Skipping relationship field: ${field.Name} (${field.FieldName})`);
                        return false;
                    }
                    
                    // Skip lookup fields (field name contains table reference like tbl9721_)
                    if (/tbl\d+_/.test(field.FieldName)) {
                        console.log(`   ‚è≠Ô∏è Skipping lookup field: ${field.Name} (${field.FieldName})`);
                        return false;
                    }
                    
                    // Skip formula fields (can have dependencies on other fields)
                    if (field.IsFormula) {
                        console.log(`   ‚è≠Ô∏è Skipping formula field: ${field.Name} (${field.FieldName}) - Formula: ${field.Formula || 'N/A'}`);
                        return false;
                    }
                    
                    return true;
                });
                
                const skippedCount = sourceFields.length - customFields.length - 5;
                console.log(`üìù Step 2: Duplicating ${customFields.length} custom fields (${skippedCount} fields skipped: relationships + formulas + lookups)...`);

                // Step 3: Create each field
                const fieldResults = [];
                for (let i = 0; i < customFields.length; i++) {
                    const field = customFields[i];
                    let fieldTypeDisplay = field.FieldType;
                    if (field.FieldType === 'ENUM') {
                        fieldTypeDisplay = `${field.FieldType} (Multiple Choice)`;
                    } else if (field.FieldType === 'ENUM2') {
                        fieldTypeDisplay = `${field.FieldType} (Multi-Select)`;
                    }
                    console.log(`   Creating field ${i + 1}/${customFields.length}: ${field.Name} (${fieldTypeDisplay})`);
                    
                    try {
                        const result = await createFieldInTable(field, newTable.Key);
                        fieldResults.push({ success: true, field: field.Name, fieldType: field.FieldType, result });
                        
                        // Store field key mapping: source field key -> new field key
                        if (field.Key && result.Key) {
                            fieldKeyMapping[field.Key] = result.Key;
                            console.log(`   üîë Mapped: ${field.Key} ‚Üí ${result.Key}`);
                        }
                        
                        console.log(`   ‚úÖ Created: ${field.Name}`);
                    } catch (error) {
                        fieldResults.push({ success: false, field: field.Name, fieldType: field.FieldType, error });
                        console.error(`   ‚ùå Failed: ${field.Name} (${fieldTypeDisplay})`);
                        console.error(`      Error details:`, error);
                        
                        // Try to parse error message for more details
                        try {
                            const errorObj = typeof error === 'string' ? JSON.parse(error) : error;
                            console.error(`      Server message:`, errorObj);
                        } catch (e) {
                            console.error(`      Raw error:`, error);
                        }
                    }
                }

                // Show results
                const successCount = fieldResults.filter(r => r.success).length;
                const failCount = fieldResults.filter(r => !r.success).length;

                console.log('‚úÖ Fields created:');
                console.log(`   ‚úÖ Successfully created: ${successCount} fields`);
                if (failCount > 0) {
                    console.log(`   ‚ùå Failed: ${failCount} fields`);
                }

                // Step 4: Create forms if any are selected
                const formResults = [];
                if (selectedFormsForDuplication.length > 0) {
                    console.log(`üìù Step 4: Duplicating ${selectedFormsForDuplication.length} form(s)...`);
                    console.log('   ‚ÑπÔ∏è Note: FormRules will be included. EmbeddedReports/EmbeddedForms excluded (reference external tables)');
                    
                    for (let i = 0; i < selectedFormsForDuplication.length; i++) {
                        const selectedForm = selectedFormsForDuplication[i];
                        console.log(`   Creating form ${i + 1}/${selectedFormsForDuplication.length}: ${selectedForm.name}`);
                        
                        try {
                            const result = await createFormInTable(selectedForm.key, newTable.Key);
                            formResults.push({ success: true, form: selectedForm.name, result });
                            console.log(`   ‚úÖ Created form: ${selectedForm.name}`);
                        } catch (error) {
                            formResults.push({ success: false, form: selectedForm.name, error });
                            console.error(`   ‚ùå Failed form: ${selectedForm.name}`, error);
                        }
                    }
                    
                    const formSuccessCount = formResults.filter(r => r.success).length;
                    const formFailCount = formResults.filter(r => !r.success).length;
                    console.log('‚úÖ Forms created:');
                    console.log(`   ‚úÖ Successfully created: ${formSuccessCount} forms`);
                    if (formFailCount > 0) {
                        console.log(`   ‚ùå Failed: ${formFailCount} forms`);
                    }
                } else {
                    console.log('‚ÑπÔ∏è No forms selected for duplication, skipping form creation.');
                }

                console.log('üéâ Duplication complete!');

                $('#loadingSpinner').hide();
                showDuplicationSuccess(tableName, singularName, newTable, fieldResults, formResults);

            } catch (error) {
                console.error('‚ùå Error during duplication:', error);
                $('#loadingSpinner').hide();
                $('#formSection').show();
                alert('Failed to duplicate table: ' + error);
            }
        }

        /**
         * Create table in destination app
         */
        function createTableInDestination(tableName, singularName) {
            return new Promise((resolve, reject) => {
                if (!destAppId) {
                    reject('No destination application selected');
                    return;
                }

                const payload = {
                    ApplicationId: destAppId,
                    Name: tableName,
                    SingularReference: singularName
                };

                $.ajax({
                    url: SERVER_URL_PAGE + '/api/applicationtable',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                    },
                    success: function(response) {
                        resolve(response);
                    },
                    error: function(xhr, status, error) {
                        reject(xhr.responseText || error);
                    }
                });
            });
        }

        /**
         * Create field in table
         */
        async function createFieldInTable(sourceField, targetTableKey) {
            // Use the renamed field name if it exists, otherwise use original
            const newFieldName = fieldNameMappings[sourceField.FieldName] || sourceField.Name;
            
            // Use the new field type if it exists, otherwise use original
            const newFieldType = fieldTypeMappings[sourceField.FieldName] || sourceField.FieldType;
            
            // For ENUM (multiple-choice) and ENUM2 (multi-select) fields, fetch dropdown values
            let dropdownValues = sourceField.Values || [];
            if ((newFieldType === 'ENUM' || newFieldType === 'ENUM2' || 
                 sourceField.FieldType === 'ENUM' || sourceField.FieldType === 'ENUM2') && sourceField.Key) {
                const fieldTypeLabel = newFieldType === 'ENUM2' ? 'Multi-Select' : 'Multiple Choice';
                console.log(`   üîç Fetching dropdown values for ${newFieldType} field: ${sourceField.Name} (${fieldTypeLabel})`);
                try {
                    dropdownValues = await fetchDropdownValues(sourceField.Key);
                    console.log(`   ‚úÖ Found ${dropdownValues.length} option(s) for ${fieldTypeLabel} field`);
                } catch (error) {
                    console.warn(`   ‚ö†Ô∏è Could not fetch dropdown values, using empty array:`, error);
                    dropdownValues = [];
                }
            }
            
            const payload = {
                Name: newFieldName,
                FieldType: newFieldType,
                ApplicationTableKey: targetTableKey,
                IsUnique: sourceField.IsUnique || false,
                IsNullable: sourceField.IsNullable || false,
                IsExternalUrl: sourceField.IsExternalUrl || false,
                IsHtmlAllowed: sourceField.IsHtmlAllowed || false,
                IsFlyAdditionAllowed: sourceField.IsFlyAdditionAllowed || false,
                IsAlphaSort: sourceField.IsAlphaSort || false,
                onGroupingSummaryType: null,
                Values: dropdownValues, // Use fetched values for ENUM/ENUM2 fields
                Formula: sourceField.Formula || "",
                EvalFormula: sourceField.EvalFormula || null,
                IsFormula: sourceField.IsFormula || false,
                FormulaFields: sourceField.FormulaFields || null,
                FieldSize: sourceField.FieldSize || 100,
                Key: null,
                PIILength: sourceField.PIILength || null,
                PIIDirection: sourceField.PIIDirection || null,
                LinkText: sourceField.LinkText || null,
                EnableDoc: sourceField.EnableDoc || false,
                IsUrl: sourceField.IsUrl || false,
                IsHtml: sourceField.IsHtml || false,
                IsRelation: false,
                LookupDisplayName: sourceField.LookupDisplayName || null,
                LookupTargetFieldKey: sourceField.LookupTargetFieldKey || null,
                Info: sourceField.Info || null,
                AlwaysExecuteOnCreateRecord: sourceField.AlwaysExecuteOnCreateRecord || false,
                FieldRoles: sourceField.FieldRoles || null
            };

            return new Promise((resolve, reject) => {
                $.ajax({
                    url: SERVER_URL_PAGE + '/api/Field',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                    },
                    success: function(response) {
                        resolve(response);
                    },
                    error: function(xhr, status, error) {
                        reject(xhr.responseText || error);
                    }
                });
            });
        }

        /**
         * Fetch dropdown values for ENUM fields
         */
        function fetchDropdownValues(fieldKey) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: SERVER_URL_PAGE + '/api/Field/getdropdownvalues',
                    type: 'GET',
                    data: { id: fieldKey },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                    },
                    success: function(response) {
                        // Transform the response to match the expected format
                        const values = (response || []).map((item, index) => ({
                            IsActive: item.IsActive !== false, // Default to true if not specified
                            value: item.value || item.Value || "",
                            FieldKey: "", // New field, so empty key
                            Order: item.Order || (index + 1)
                        }));
                        resolve(values);
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to fetch dropdown values:', error);
                        reject(xhr.responseText || error);
                    }
                });
            });
        }

        /**
         * Load form structure and create it in the new table
         */
        async function createFormInTable(sourceFormKey, targetTableKey) {
            // First, load the full form structure
            const formStructure = await loadFormStructureForDuplication(sourceFormKey);
            
            // Transform the form structure for the new table
            const transformedForm = transformFormStructure(formStructure, targetTableKey);
            
            // Create the form via API
            return createForm(transformedForm);
        }

        /**
         * Load form structure from API
         */
        function loadFormStructureForDuplication(formKey) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: SERVER_URL_PAGE + '/api/form/loadformtoedit',
                    type: 'GET',
                    data: { 
                        id: formKey,
                        tableId: sourceTableKey
                    },
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                    },
                    success: function(response) {
                        console.log('   üìÑ Form structure loaded:', formKey);
                        resolve(response);
                    },
                    error: function(xhr, status, error) {
                        console.error('   ‚ùå Failed to load form structure:', error);
                        reject(xhr.responseText || error);
                    }
                });
            });
        }

        /**
         * Transform form structure to work with new table and field keys
         */
        function transformFormStructure(sourceForm, targetTableKey) {
            const transformed = {
                ApplicationTableKey: targetTableKey,
                Name: sourceForm.Name,
                Description: sourceForm.Description || null,
                DefaultForm: sourceForm.DefaultForm || 0,
                Type: sourceForm.Type || 'web',
                GenerateQRCode: sourceForm.GenerateQRCode || false,
                HasCustomButtons: sourceForm.HasCustomButtons || 0,
                Key: null, // Let API generate new key
                PrimaryDisplayFieldKey: mapFieldKey(sourceForm.PrimaryDisplayFieldKey),
                SecondaryDisplayFieldKey: mapFieldKey(sourceForm.SecondaryDisplayFieldKey),
                HeaderFields: transformHeaderFields(sourceForm.HeaderFields || [], targetTableKey),
                TabData: transformTabData(sourceForm.TabData || [], targetTableKey),
                Status: sourceForm.Status || [],
                SortLevels: sourceForm.SortLevels || [],
                // EXCLUDE complex optional features that reference external tables:
                // - EmbeddedReports: References other tables - EXCLUDE
                // - EmbeddedForms: References other tables - EXCLUDE
                // - FormPdfMaps: PDF mapping can be configured later
                // - DataFilters: Filters can be added later
                // - ApplicationRoleForms: Permissions can be set later
                EmbeddedReports: [],
                EmbeddedForms: [],
                FormPdfMaps: [],
                PdfFormFile: { Base64EncodedFile: null, Value: null },
                WordFile: { Base64EncodedFile: null, Value: null },
                DataFilters: [],
                // INCLUDE FormRules with field key remapping (they only reference fields in this form)
                FormRule: transformFormRules(sourceForm.FormRule || []),
                ApplicationRoleForms: []
            };
            
            const ruleCount = transformed.FormRule.length;
            console.log(`   üìã Form transformation: ${ruleCount} FormRule(s) included (reports/filters excluded)`);
            
            return transformed;
        }

        /**
         * Transform FormRules to use new field keys
         * FormRules contain conditional logic that references field keys
         */
        function transformFormRules(formRules) {
            if (!formRules || formRules.length === 0) return [];
            
            return formRules.map(rule => {
                const transformedRule = {
                    // Keep basic rule properties (no Key/Id - let API generate)
                    FormRuleIndex: rule.FormRuleIndex,
                    IsFormRuleActive: rule.IsFormRuleActive,
                    Name: rule.Name,
                    // Transform FormConditionGroups (the "IF" conditions)
                    FormConditionGroups: transformFormConditionGroups(rule.FormConditionGroups || []),
                    // Transform FormRuleConditions (the "THEN" actions)
                    FormRuleConditions: transformFormRuleConditions(rule.FormRuleConditions || [])
                };
                
                return transformedRule;
            });
        }

        /**
         * Transform FormConditionGroups (the "IF" part of rules)
         */
        function transformFormConditionGroups(conditionGroups) {
            if (!conditionGroups || conditionGroups.length === 0) return [];
            
            return conditionGroups.map(group => {
                return {
                    ConditionType: group.ConditionType,
                    FormGroups: (group.FormGroups || []).map(formGroup => {
                        return {
                            ConditionType: formGroup.ConditionType,
                            // Transform Conditions to use new field keys
                            Conditions: (formGroup.Conditions || []).map(condition => {
                                return {
                                    Operand: condition.Operand,
                                    Operator: condition.Operator,
                                    Value: condition.Value,
                                    // Remap the FieldKey to new field key
                                    FieldKey: mapFieldKey(condition.FieldKey) || condition.FieldKey
                                };
                            })
                        };
                    })
                };
            });
        }

        /**
         * Transform FormRuleConditions (the "THEN" part of rules - what actions to take)
         */
        function transformFormRuleConditions(ruleConditions) {
            if (!ruleConditions || ruleConditions.length === 0) return [];
            
            return ruleConditions.map(condition => {
                const transformed = {
                    Action: condition.Action, // e.g., "hide", "show", "require"
                    Type: condition.Type, // e.g., "field", "tab"
                    DisplayMessage: condition.DisplayMessage,
                    IsTrue: condition.IsTrue,
                    PreventSave: condition.PreventSave,
                    AllTabsSelected: condition.AllTabsSelected
                };
                
                // If this condition references a field, remap the field key
                if (condition.Type === 'field' && condition.Value) {
                    transformed.Value = mapFieldKey(condition.Value) || condition.Value;
                    transformed.FieldKey = mapFieldKey(condition.FieldKey) || condition.FieldKey;
                } else {
                    transformed.Value = condition.Value;
                }
                
                return transformed;
            });
        }

        /**
         * Transform TabData to use new field keys
         */
        function transformTabData(tabData, targetTableKey) {
            if (!tabData || tabData.length === 0) return [];
            
            return tabData.map((tab, index) => {
                return {
                    Order: tab.Order !== undefined ? tab.Order : index,
                    Title: tab.Title,
                    Sections: tab.Sections || [],
                    Columns: (tab.Columns || []).map(column => transformFormColumn(column, targetTableKey)),
                    Footer: tab.Footer || [],
                    HideForAdmin: tab.HideForAdmin !== undefined ? tab.HideForAdmin : null,
                    HideForParticipants: tab.HideForParticipants !== undefined ? tab.HideForParticipants : null,
                    Previous: tab.Previous !== undefined ? tab.Previous : null,
                    Next: tab.Next !== undefined ? tab.Next : null,
                    SaveAndContinue: tab.SaveAndContinue !== undefined ? tab.SaveAndContinue : null,
                    SaveAndExit: tab.SaveAndExit !== undefined ? tab.SaveAndExit : null,
                    Cancel: tab.Cancel !== undefined ? tab.Cancel : null,
                    isContentHidden: tab.isContentHidden || false,
                    isTabNameEditable: tab.isTabNameEditable || false
                };
            });
        }

        /**
         * Transform a form column (field) to use new field key
         */
        function transformFormColumn(column, targetTableKey) {
            // Special case: HTML/Design elements and Dividers (no FieldKey, IsStyleOption = true)
            if (column.IsStyleOption && (column.DbFieldType === 'HTML' || column.DbFieldType === 'DIVIDER')) {
                const elementType = column.DbFieldType === 'DIVIDER' ? 'Divider' : 'HTML';
                console.log(`   üé® Including design element: ${column.Name} (${elementType})`);
                return {
                    ApplicationTableKey: targetTableKey, // Use the new table key
                    FieldKey: "", // Design elements have empty FieldKey
                    TabIndex: column.TabIndex !== undefined ? column.TabIndex : 0,
                    IsReportToggled: column.IsReportToggled || false,
                    DbFieldType: column.DbFieldType,
                    FieldSize: column.FieldSize !== undefined && column.FieldSize !== null ? column.FieldSize : null,
                    DisplayRowIndex: column.DisplayRowIndex !== undefined ? column.DisplayRowIndex : 0,
                    DisplayColumnIndex: column.DisplayColumnIndex !== undefined ? column.DisplayColumnIndex : 0,
                    DropdownLabelKey: column.DropdownLabelKey || null,
                    DropdownLabelType: column.DropdownLabelType || null,
                    IsStyleOption: true,
                    FieldName: column.FieldName,
                    Name: column.Name,
                    GeneralType: column.GeneralType || "string",
                    DependentFieldKey: null,
                    LinkText: column.LinkText || "",
                    FormStyleOption: column.FormStyleOption ? {
                        Name: column.FormStyleOption.Name,
                        Type: column.FormStyleOption.Type || column.DbFieldType, // Use DbFieldType as fallback
                        TextAlignment: column.FormStyleOption.TextAlignment || "left",
                        EvaluateTab: column.FormStyleOption.EvaluateTab || false,
                        TextColor: column.FormStyleOption.TextColor || "",
                        ButtonColor: column.FormStyleOption.ButtonColor || "",
                        Icon: column.FormStyleOption.Icon || "",
                        IsIcon: column.FormStyleOption.IsIcon || null,
                        IconColor: column.FormStyleOption.IconColor || null,
                        IsSaveAndExit: column.FormStyleOption.IsSaveAndExit || false,
                        IsCustom: column.FormStyleOption.IsCustom !== undefined ? column.FormStyleOption.IsCustom : 0,
                        ValueOfFieldKey: column.FormStyleOption.ValueOfFieldKey || null,
                        FieldChangeValue: column.FormStyleOption.FieldChangeValue || [],
                        FieldAddRecord: column.FormStyleOption.FieldAddRecord || []
                    } : null,
                    FormFieldSetting: transformFormFieldSetting(column.FormFieldSetting, ""),
                    IsFlyAdditionAllowed: column.IsFlyAdditionAllowed || false,
                    IsHeader: column.IsHeader !== undefined ? column.IsHeader : false,
                    Reports: column.Reports || null
                };
            }
            
            // Regular field: needs mapping to new field key
            const newFieldKey = mapFieldKey(column.FieldKey);
            
            // Only include this field if we successfully created it
            if (!newFieldKey) {
                console.log(`   ‚ö†Ô∏è Skipping field in form (not created): ${column.Name} (${column.FieldKey})`);
                return null;
            }
            
            const transformed = {
                ApplicationTableKey: targetTableKey, // Use the new table key
                FieldKey: newFieldKey,
                TabIndex: column.TabIndex !== undefined ? column.TabIndex : 0,
                IsReportToggled: column.IsReportToggled || false,
                DbFieldType: column.DbFieldType,
                FieldSize: column.FieldSize !== undefined && column.FieldSize !== null ? column.FieldSize : null,
                DisplayRowIndex: column.DisplayRowIndex !== undefined ? column.DisplayRowIndex : 0,
                DisplayColumnIndex: column.DisplayColumnIndex !== undefined ? column.DisplayColumnIndex : 0,
                DropdownLabelKey: column.DropdownLabelKey || null,
                DropdownLabelType: column.DropdownLabelType || null,
                IsStyleOption: column.IsStyleOption || false,
                FieldName: column.FieldName,
                Name: column.Name,
                GeneralType: column.GeneralType || "string",
                DependentFieldKey: mapFieldKey(column.DependentFieldKey) || null,
                FormFieldSetting: transformFormFieldSetting(column.FormFieldSetting, newFieldKey),
                IsFlyAdditionAllowed: column.IsFlyAdditionAllowed || false,
                IsHeader: column.IsHeader !== undefined ? column.IsHeader : false,
                Reports: column.Reports || null
            };
            
            return transformed;
        }

        /**
         * Transform FormFieldSetting to use new field key
         */
        function transformFormFieldSetting(setting, newFieldKey) {
            if (!setting) {
                return {
                    ConditionGroup: [
                        { Id: 0, ConditionType: null, AppliedOn: "required", Conditions: [] },
                        { Id: 0, ConditionType: null, AppliedOn: "hidden", Conditions: [] },
                        { Id: 0, ConditionType: null, AppliedOn: "readonly", Conditions: [] },
                        { Id: 0, ConditionType: null, AppliedOn: "restrict", Conditions: [] }
                    ],
                    IsFormFieldNameHidden: false,
                    ESignEnabled: false,
                    FormFieldName: null,
                    FieldKey: newFieldKey,
                    DropdownLabelKey: null,
                    DropdownLabelType: null,
                    Required: 0,
                    Hidden: 0,
                    Readonly: 0,
                    Minimum: 0.00,
                    Maximum: 0.00,
                    CharacterCount: null,
                    Regex: null,
                    FileExtension: null,
                    FileSize: null,
                    RestrictChoices: false,
                    FormFieldValue: 0,
                    DefaultValue: null,
                    HasDefaultValue: false,
                    MaintainLastValue: false,
                    IncludeInfoText: false,
                    DisplayType: 2,
                    AllowMinimize: false,
                    AllowQRCodeScan: false,
                    IsRichTextFormat: false,
                    RenderAsButton: false,
                    OpenInline: false,
                    IncludeLink: false,
                    ParentFormKey: null,
                    RelatedRecordFormKey: null
                };
            }
            
            return {
                ConditionGroup: setting.ConditionGroup || [
                    { Id: 0, ConditionType: null, AppliedOn: "required", Conditions: [] },
                    { Id: 0, ConditionType: null, AppliedOn: "hidden", Conditions: [] },
                    { Id: 0, ConditionType: null, AppliedOn: "readonly", Conditions: [] },
                    { Id: 0, ConditionType: null, AppliedOn: "restrict", Conditions: [] }
                ],
                IsFormFieldNameHidden: setting.IsFormFieldNameHidden || false,
                ESignEnabled: setting.ESignEnabled || false,
                FormFieldName: setting.FormFieldName || null,
                FieldKey: newFieldKey,
                DropdownLabelKey: setting.DropdownLabelKey || null,
                DropdownLabelType: setting.DropdownLabelType || null,
                Required: setting.Required || 0,
                Hidden: setting.Hidden || 0,
                Readonly: setting.Readonly || 0,
                Minimum: setting.Minimum || 0.00,
                Maximum: setting.Maximum || 0.00,
                CharacterCount: setting.CharacterCount || null,
                Regex: setting.Regex || null,
                FileExtension: setting.FileExtension || null,
                FileSize: setting.FileSize || null,
                RestrictChoices: setting.RestrictChoices || false,
                FormFieldValue: setting.FormFieldValue || 0,
                DefaultValue: setting.DefaultValue || null, // IMPORTANT: Preserves HTML for design elements
                HasDefaultValue: setting.HasDefaultValue || false,
                MaintainLastValue: setting.MaintainLastValue || false,
                IncludeInfoText: setting.IncludeInfoText !== undefined ? setting.IncludeInfoText : false,
                DisplayType: setting.DisplayType !== undefined ? setting.DisplayType : 2,
                AllowMinimize: setting.AllowMinimize || false,
                AllowQRCodeScan: setting.AllowQRCodeScan || false,
                IsRichTextFormat: setting.IsRichTextFormat || false,
                RenderAsButton: setting.RenderAsButton || false,
                OpenInline: setting.OpenInline || false,
                IncludeLink: setting.IncludeLink || false,
                ParentFormKey: setting.ParentFormKey || null,
                RelatedRecordFormKey: setting.RelatedRecordFormKey || null
            };
        }

        /**
         * Transform HeaderFields to use new field keys
         */
        function transformHeaderFields(headerFields, targetTableKey) {
            if (!headerFields || headerFields.length === 0) return [];
            
            return headerFields
                .map(field => transformFormColumn(field, targetTableKey))
                .filter(field => field !== null); // Remove fields that couldn't be mapped
        }

        /**
         * Map source field key to new field key (helper)
         */
        function mapFieldKey(sourceKey) {
            if (!sourceKey) return null;
            return fieldKeyMapping[sourceKey] || null;
        }

        /**
         * Create form via API
         */
        function createForm(formPayload) {
            return new Promise((resolve, reject) => {
                // Filter out null columns (fields that weren't created)
                let removedFieldsCount = 0;
                if (formPayload.TabData) {
                    formPayload.TabData.forEach(tab => {
                        if (tab.Columns) {
                            const originalCount = tab.Columns.length;
                            tab.Columns = tab.Columns.filter(col => col !== null);
                            const filteredCount = originalCount - tab.Columns.length;
                            if (filteredCount > 0) {
                                removedFieldsCount += filteredCount;
                                console.log(`   ‚ö†Ô∏è Removed ${filteredCount} unmapped field(s) from tab: ${tab.Title}`);
                            }
                        }
                    });
                }
                
                if (removedFieldsCount > 0) {
                    console.log(`   ‚ÑπÔ∏è Total unmapped fields removed from form: ${removedFieldsCount}`);
                }
                
                // CLEAN: Remove undefined values from payload
                console.log('   üßπ Cleaning undefined values from payload...');
                formPayload = cleanUndefinedValues(formPayload);
                
                // VALIDATION: Check for problematic data
                console.log('   üîç Validating form payload...');
                const validationIssues = validateFormPayload(formPayload);
                if (validationIssues.length > 0) {
                    console.warn('   ‚ö†Ô∏è Validation issues found:');
                    validationIssues.forEach(issue => console.warn(`      - ${issue}`));
                }
                
                // Log summary before sending
                const totalTabs = formPayload.TabData ? formPayload.TabData.length : 0;
                const totalFields = formPayload.TabData 
                    ? formPayload.TabData.reduce((sum, tab) => sum + (tab.Columns ? tab.Columns.length : 0), 0)
                    : 0;
                console.log(`   üìã Form summary: ${totalTabs} tab(s), ${totalFields} field(s)`);
                console.log('   üì§ Sending form payload:', formPayload);
                
                // Create compact JSON string (no pretty printing for actual send)
                const payloadString = JSON.stringify(formPayload);
                console.log('   üìè Payload size:', (payloadString.length / 1024).toFixed(2), 'KB');
                
                // Log a download link for the full payload (for debugging) - pretty printed version
                const prettyPayload = JSON.stringify(formPayload, null, 2);
                console.log('   üíæ To download full payload for inspection, run this in console:');
                console.log(`   const blob = new Blob([${JSON.stringify(prettyPayload)}], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'form-payload.json'; a.click();`);
                
                $.ajax({
                    url: SERVER_URL_PAGE + '/api/Form',
                    type: 'POST',
                    contentType: 'application/json',
                    data: payloadString,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                    },
                    success: function(response) {
                        console.log('   ‚úÖ Form created successfully:', response);
                        resolve(response);
                    },
                    error: function(xhr, status, error) {
                        console.error('   ‚ùå Form creation failed:', xhr.responseText || error);
                        console.error('   üìä HTTP Status:', xhr.status);
                        console.error('   üìã Response:', xhr.responseJSON || xhr.responseText);
                        
                        // Try to provide more specific error info
                        if (xhr.status === 500) {
                            console.error('   ‚ö†Ô∏è Server error (500) - Check form structure for invalid data');
                            console.error('   üí° Common issues: undefined values, missing required fields, invalid field keys');
                            
                            // Log first tab structure for debugging
                            if (formPayload.TabData && formPayload.TabData.length > 0) {
                                console.error('   üîç Sample tab structure (first tab):', formPayload.TabData[0]);
                                if (formPayload.TabData[0].Columns && formPayload.TabData[0].Columns.length > 0) {
                                    console.error('   üîç Sample column (first field):', formPayload.TabData[0].Columns[0]);
                                }
                            }
                        }
                        
                        reject(xhr.responseText || error);
                    }
                });
            });
        }

        /**
         * Recursively remove undefined values from an object
         */
        function cleanUndefinedValues(obj) {
            if (obj === null || obj === undefined) return obj;
            
            if (Array.isArray(obj)) {
                return obj.map(item => cleanUndefinedValues(item)).filter(item => item !== undefined);
            }
            
            if (typeof obj === 'object') {
                const cleaned = {};
                Object.keys(obj).forEach(key => {
                    const value = obj[key];
                    if (value !== undefined) {
                        cleaned[key] = cleanUndefinedValues(value);
                    }
                });
                return cleaned;
            }
            
            return obj;
        }

        /**
         * Validate form payload for common issues
         */
        function validateFormPayload(payload) {
            const issues = [];
            
            // Check TabData
            if (!payload.TabData || payload.TabData.length === 0) {
                issues.push('No tabs in form');
            } else {
                payload.TabData.forEach((tab, tabIndex) => {
                    // Check for undefined Order
                    if (tab.Order === undefined) {
                        issues.push(`Tab ${tabIndex} (${tab.Title}) has undefined Order`);
                    }
                    
                    // Check columns
                    if (tab.Columns) {
                        tab.Columns.forEach((col, colIndex) => {
                            if (!col) {
                                issues.push(`Tab ${tabIndex} has null column at index ${colIndex}`);
                            } else {
                                // Check for required properties
                                if (col.DisplayRowIndex === undefined) {
                                    issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) missing DisplayRowIndex`);
                                }
                                if (col.DisplayColumnIndex === undefined) {
                                    issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) missing DisplayColumnIndex`);
                                }
                                if (col.TabIndex === undefined) {
                                    issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) missing TabIndex`);
                                }
                                
                                // Check FormFieldSetting
                                if (!col.FormFieldSetting) {
                                    issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) missing FormFieldSetting`);
                                } else {
                                    // Check ConditionGroup structure
                                    if (col.FormFieldSetting.ConditionGroup) {
                                        col.FormFieldSetting.ConditionGroup.forEach((cg, cgIndex) => {
                                            if (cg.Id === undefined) {
                                                issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) ConditionGroup ${cgIndex} missing Id`);
                                            }
                                            if (!cg.hasOwnProperty('ConditionType')) {
                                                issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) ConditionGroup ${cgIndex} missing ConditionType`);
                                            }
                                            if (!cg.AppliedOn) {
                                                issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) ConditionGroup ${cgIndex} missing AppliedOn`);
                                            }
                                            if (!Array.isArray(cg.Conditions)) {
                                                issues.push(`Tab ${tabIndex}, Column ${colIndex} (${col.Name}) ConditionGroup ${cgIndex} Conditions is not an array`);
                                            }
                                        });
                                    }
                                }
                            }
                        });
                    }
                });
            }
            
            return issues;
        }

        /**
         * Show duplication success
         */
        function showDuplicationSuccess(tableName, singularName, newTable, fieldResults, formResults) {
            formResults = formResults || []; // Default to empty array if not provided
            
            const successCount = fieldResults.filter(r => r.success).length;
            const failCount = fieldResults.filter(r => !r.success).length;

            let fieldResultsHtml = '';
            if (failCount > 0) {
                const failedFieldsList = fieldResults
                    .filter(r => !r.success)
                    .map(r => `${r.field} (${r.fieldType || 'Unknown'})`)
                    .join(', ');
                    
                fieldResultsHtml = `
                    <div class="mb-2">
                        <small class="text-muted">Fields Created:</small>
                        <div>
                            <span class="badge bg-success">${successCount} successful</span>
                            <span class="badge bg-danger ms-2">${failCount} failed</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted text-danger">Failed Fields:</small>
                        <div class="small text-danger">
                            ${failedFieldsList}
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">üí° Check browser console for detailed error messages</small>
                        </div>
                    </div>
                `;
            } else {
                fieldResultsHtml = `
                    <div class="mb-2">
                        <small class="text-muted">Fields Created:</small>
                        <div><span class="badge bg-success">${successCount} fields</span></div>
                    </div>
                `;
            }
            
            // Add form results if any
            let formResultsHtml = '';
            if (formResults.length > 0) {
                const formSuccessCount = formResults.filter(r => r.success).length;
                const formFailCount = formResults.filter(r => !r.success).length;
                
                if (formFailCount > 0) {
                    formResultsHtml = `
                        <div class="mb-2">
                            <small class="text-muted">Forms Created:</small>
                            <div>
                                <span class="badge bg-success">${formSuccessCount} successful</span>
                                <span class="badge bg-danger ms-2">${formFailCount} failed</span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Failed Forms:</small>
                            <div class="small text-danger">
                                ${formResults.filter(r => !r.success).map(r => r.form).join(', ')}
                            </div>
                        </div>
                    `;
                } else {
                    formResultsHtml = `
                        <div class="mb-2">
                            <small class="text-muted">Forms Created:</small>
                            <div><span class="badge bg-success">${formSuccessCount} forms</span></div>
                        </div>
                    `;
                }
            }
            
            const successHtml = `
                <div class="alert alert-light border">
                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1"><i class="bi bi-box-arrow-up-right me-1"></i>Source Table:</small>
                        <div><strong>${sourceTableName}</strong></div>
                        <small class="text-muted">From App: ${sourceAppKey}</small>
                    </div>
                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1"><i class="bi bi-box-arrow-in-down me-1"></i>New Table Created:</small>
                        <div><strong>${tableName}</strong></div>
                        <small class="text-muted">In App: ${destAppName} (ID: ${destAppId})</small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Table Key:</small>
                        <div><strong>${newTable.Key}</strong></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Table ID:</small>
                        <div><strong>${newTable.Id}</strong></div>
                    </div>
                    ${fieldResultsHtml}
                    ${formResultsHtml}
                </div>
            `;
            
            $('#successDetails').html(successHtml);
            $('#successSection').removeClass('hidden');
        }

        /**
         * Lookup application by key (OLD - keeping for API testers)
         */
        function lookupApplication() {
            const appKey = $('#tableAppKey').val().trim();
            
            if (!appKey) {
                alert('Please enter an Application Key');
                return;
            }

            console.log('üîç Looking up application with key:', appKey);

            // Disable button and show loading state
            $('#lookupAppBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
            $('#appDetailsContainer').addClass('hidden');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/Application/getall',
                type: 'GET',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Applications retrieved');
                    
                    // Find the app with matching key
                    const app = response.find(a => a.Key === appKey);
                    
                    if (app) {
                        console.log('‚úÖ Found application:', app);
                        
                        // Store app details globally
                        selectedAppId = app.Id;
                        selectedAppKey = app.Key;
                        selectedAppName = app.Name;
                        
                        // Display app details
                        $('#appDetailsName').text(app.Name);
                        $('#appDetailsId').text(app.Id);
                        $('#appDetailsContainer').removeClass('hidden');
                        
                        console.log(`üìã App ID ${selectedAppId} will be used for table creation`);
                        
                        // Validate form now that we have app ID
                        validateForm();
                    } else {
                        console.warn('‚ö†Ô∏è No application found with key:', appKey);
                        alert(`No application found with key: ${appKey}`);
                        
                        // Clear stored values
                        selectedAppId = null;
                        selectedAppKey = null;
                        selectedAppName = null;
                    }
                    
                    // Re-enable button
                    $('#lookupAppBtn').prop('disabled', false).html('<i class="bi bi-search me-1"></i>Lookup');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error looking up application:', error);
                    alert('Failed to lookup application: ' + error);
                    
                    // Re-enable button
                    $('#lookupAppBtn').prop('disabled', false).html('<i class="bi bi-search me-1"></i>Lookup');
                }
            });
        }

        /**
         * Validate duplicate form
         */
        function validateDuplicateForm() {
            const sourceAppKey = $('#sourceAppKey').val().trim();
            const sourceTable = $('#sourceTableDropdown').val();
            const destAppKey = $('#destAppKey').val().trim();
            const tableName = $('#tableName').val().trim();
            const singularName = $('#singularName').val().trim();
            
            // Form is valid if we have:
            // - Source app key
            // - Source table selected
            // - Source fields loaded
            // - Destination app ID (from successful lookup)
            // - New table name and singular name
            const isValid = sourceAppKey && sourceTable && sourceFields.length > 0 && 
                          destAppId && tableName && singularName;
            
            $('#duplicateTableBtn').prop('disabled', !isValid);
            
            return isValid;
        }

        /**
         * Validate form (OLD - keeping for API testers)
         */
        function validateForm() {
            const appKey = $('#tableAppKey').val().trim();
            const tableName = $('#tableName').val().trim();
            const singularName = $('#singularName').val().trim();
            
            // Form is valid if we have app ID (from successful lookup) and both names
            const isValid = selectedAppId && tableName && singularName;
            $('#createTableBtn').prop('disabled', !isValid);
            
            return isValid;
        }

        /**
         * Handle create table
         */
        function handleCreateTable() {
            if (!validateForm()) {
                return;
            }

            const tableName = $('#tableName').val().trim();
            const singularName = $('#singularName').val().trim();

            console.log('Creating table:', { tableName, singularName });

            // Show loading
            $('#formSection').hide();
            $('#loadingSpinner').show();

            // Create the table via API
            createTable(tableName, singularName)
                .then((response) => {
                    console.log('‚úÖ Table created successfully:', response);
                    showSuccess(tableName, singularName, response);
                })
                .catch((error) => {
                    console.error('‚ùå Error creating table:', error);
                    $('#loadingSpinner').hide();
                    $('#formSection').show();
                    alert('Failed to create table: ' + error);
                });
        }

        /**
         * Create table via API
         */
        function createTable(tableName, singularName) {
            return new Promise((resolve, reject) => {
                if (!selectedAppId) {
                    reject('No application selected. Please lookup an application first.');
                    return;
                }

                const payload = {
                    ApplicationId: selectedAppId,
                    Name: tableName,
                    SingularReference: singularName
                };

                console.log('üì§ Sending table creation request:', payload);
                console.log(`   ‚û°Ô∏è Creating table "${tableName}" in App ID: ${selectedAppId} (${selectedAppName})`);

                $.ajax({
                    url: SERVER_URL_PAGE + '/api/applicationtable',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                    },
                    success: function(response) {
                        console.log('üì• Table creation response:', response);
                        console.log(`‚úÖ Table created successfully in App: ${selectedAppName} (ID: ${selectedAppId})`);
                        resolve(response);
                    },
                    error: function(xhr, status, error) {
                        console.error('‚ùå Table creation error:', error);
                        console.error('Response:', xhr.responseText);
                        reject(xhr.responseText || error);
                    }
                });
            });
        }

        /**
         * Show success message
         */
        function showSuccess(tableName, singularName, response) {
            $('#loadingSpinner').hide();
            
            const successHtml = `
                <div class="alert alert-light border">
                    <div class="mb-3 pb-3 border-bottom">
                        <small class="text-muted d-block mb-1"><i class="bi bi-app-indicator me-1"></i>Created in Application:</small>
                        <div><strong>${selectedAppName}</strong></div>
                        <small class="text-muted">App ID: ${selectedAppId} | App Key: ${selectedAppKey}</small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Table Name:</small>
                        <div><strong>${tableName}</strong></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Singular Name:</small>
                        <div><strong>${singularName}</strong></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Table Key:</small>
                        <div><strong>${response.Key || 'N/A'}</strong></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Table ID:</small>
                        <div><strong>${response.Id || 'N/A'}</strong></div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Default Fields Created:</small>
                        <div><strong>${response.Fields ? response.Fields.length : 0}</strong> fields (id, datecreated, datemodified, createdby, modifiedby)</div>
                    </div>
                </div>
            `;
            
            $('#successDetails').html(successHtml);
            $('#successSection').removeClass('hidden');
        }

        /**
         * Reset form
         */
        function resetForm() {
            $('#tableForm')[0].reset();
            $('#successSection').addClass('hidden');
            $('#formSection').show();
            $('#duplicateTableBtn').prop('disabled', true);
            $('#destAppDetailsContainer').addClass('hidden');
            $('#sourceTableDropdown').prop('disabled', true).html('<option value="">-- Load tables first --</option>');
            
            // Hide and clear fields table
            $('#fieldsPreviewContainer').hide();
            if (fieldsDataTable) {
                fieldsDataTable.destroy();
                fieldsDataTable = null;
            }
            $('#fieldsTable tbody').empty();
            
            // Clear stored details
            sourceAppKey = null;
            sourceTableKey = null;
            sourceTableName = null;
            sourceFields = [];
            fieldNameMappings = {};
            fieldTypeMappings = {};
            destAppId = null;
            destAppKey = null;
            destAppName = null;
            
            console.log('Form reset - ready for new duplication');
        }

        /**
         * Test GET /api/Application/getall endpoint
         */
        function testGetAllEndpoint() {
            const searchType = $('input[name="searchType"]:checked').val();
            const appKey = $('#appKeyInput').val().trim();
            const appId = $('#appIdInput').val().trim();
            
            let searchValue, searchField;
            
            if (searchType === 'key') {
                if (!appKey) {
                    alert('Please enter an Application Key');
                    return;
                }
                searchValue = appKey;
                searchField = 'Key';
                console.log('üß™ Testing GET /api/Application/getall with App Key:', appKey);
            } else {
                if (!appId) {
                    alert('Please enter an Application ID');
                    return;
                }
                searchValue = appId;
                searchField = 'Id';
                console.log('üß™ Testing GET /api/Application/getall with App ID:', appId);
            }

            // Disable button and show loading state
            $('#testEndpointBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Loading...');
            $('#apiResponseSection').addClass('hidden');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/Application/getall',
                type: 'GET',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ API Response:', response);
                    console.log(`üìä Total applications returned: ${response.length}`);
                    
                    // Filter response to only show the app with matching Key or ID
                    let filteredResponse = response;
                    if (Array.isArray(response)) {
                        if (searchType === 'key') {
                            filteredResponse = response.filter(app => app.Key === searchValue);
                            console.log(`üîç Filtered to ${filteredResponse.length} app(s) matching Key "${searchValue}"`);
                            
                            // If found, also log the App ID for reference
                            if (filteredResponse.length > 0) {
                                console.log(`‚ÑπÔ∏è Found App ID: ${filteredResponse[0].Id} for Key: ${searchValue}`);
                            }
                        } else {
                            filteredResponse = response.filter(app => app.Id == searchValue || app.ApplicationId == searchValue);
                            console.log(`üîç Filtered to ${filteredResponse.length} app(s) matching ID ${searchValue}`);
                            
                            // If found, also log the App Key for reference
                            if (filteredResponse.length > 0) {
                                console.log(`‚ÑπÔ∏è Found App Key: ${filteredResponse[0].Key} for ID: ${searchValue}`);
                            }
                        }
                    }
                    
                    displayApiResponse(200, 'OK', filteredResponse);
                    
                    // Re-enable button
                    $('#testEndpointBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Test Endpoint');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå API Error:', error);
                    console.error('Response:', xhr.responseText);
                    
                    let errorResponse = xhr.responseText;
                    try {
                        errorResponse = JSON.parse(xhr.responseText);
                    } catch (e) {
                        // Keep as string if not JSON
                    }
                    
                    displayApiResponse(xhr.status, error, errorResponse);
                    
                    // Re-enable button
                    $('#testEndpointBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Test Endpoint');
                }
            });
        }

        /**
         * Display API response
         */
        function displayApiResponse(statusCode, statusText, responseData) {
            // Update status badge
            const statusBadgeClass = statusCode >= 200 && statusCode < 300 ? 'bg-success' : 'bg-danger';
            $('#responseStatus').removeClass('bg-success bg-danger').addClass(statusBadgeClass).text(`${statusCode} ${statusText}`);
            
            // Format and display response body
            const formattedResponse = JSON.stringify(responseData, null, 2);
            $('#responseBody').text(formattedResponse);
            
            // Show response section
            $('#apiResponseSection').removeClass('hidden');
        }

        /**
         * Test GET /api/applicationtable/getbyapplicationid endpoint
         */
        function testGetApplicationTable() {
            const appKey = $('#appTableKeyInput').val().trim();
            
            if (!appKey) {
                alert('Please enter an Application Key');
                return;
            }

            console.log('üß™ Testing GET /api/applicationtable/getbyapplicationid with App Key:', appKey);

            // Disable button and show loading state
            $('#testAppTableBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Loading...');
            $('#appTableResponseSection').addClass('hidden');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/applicationtable/getbyapplicationid',
                type: 'GET',
                data: { id: appKey },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Application Tables Response:', response);
                    
                    // Count tables
                    const tableCount = Array.isArray(response) ? response.length : (response ? 1 : 0);
                    console.log(`üìä Found ${tableCount} table(s) in App Key "${appKey}"`);
                    
                    // If it's an array, log table names with details
                    if (Array.isArray(response) && response.length > 0) {
                        console.log('üìã Tables:');
                        response.forEach((table, index) => {
                            console.log(`   ${index + 1}. ${table.Name}`);
                            console.log(`      - Table ID: ${table.Id}`);
                            console.log(`      - Table Key: ${table.Key}`);
                            console.log(`      - Fields: ${table.NumberOfFields}`);
                            console.log(`      - Relations: ${table.NumberOfRelations}`);
                            console.log(`      - Rows: ${table.Rows}`);
                        });
                    }
                    
                    displayAppTableResponse(200, 'OK', response, tableCount);
                    
                    // Re-enable button
                    $('#testAppTableBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Get Tables');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå API Error:', error);
                    console.error('Response:', xhr.responseText);
                    
                    let errorResponse = xhr.responseText;
                    try {
                        errorResponse = JSON.parse(xhr.responseText);
                    } catch (e) {
                        // Keep as string if not JSON
                    }
                    
                    displayAppTableResponse(xhr.status, error, errorResponse, 0);
                    
                    // Re-enable button
                    $('#testAppTableBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Get Tables');
                }
            });
        }

        /**
         * Display Application Table API response
         */
        function displayAppTableResponse(statusCode, statusText, responseData, tableCount) {
            // Update status badge
            const statusBadgeClass = statusCode >= 200 && statusCode < 300 ? 'bg-success' : 'bg-danger';
            $('#appTableResponseStatus').removeClass('bg-success bg-danger').addClass(statusBadgeClass).text(`${statusCode} ${statusText}`);
            
            // Update table count
            $('#appTableCount').text(tableCount);
            
            // Format and display response body
            const formattedResponse = JSON.stringify(responseData, null, 2);
            $('#appTableResponseBody').text(formattedResponse);
            
            // Show response section
            $('#appTableResponseSection').removeClass('hidden');
        }

        /**
         * Test GET /api/Field/getbytableid endpoint
         */
        function testGetTableFields() {
            const tableKey = $('#tableKeyInput').val().trim();
            
            if (!tableKey) {
                alert('Please enter a Table Key');
                return;
            }

            console.log('üß™ Testing GET /api/Field/getbytableid with Table Key:', tableKey);

            // Disable button and show loading state
            $('#testTableFieldsBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Loading...');
            $('#tableFieldsResponseSection').addClass('hidden');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/Field/getbytableid',
                type: 'GET',
                data: { id: tableKey },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Table Fields Response:', response);
                    
                    // Count fields
                    const fieldCount = Array.isArray(response) ? response.length : (response ? 1 : 0);
                    console.log(`üìä Found ${fieldCount} field(s) in Table Key "${tableKey}"`);
                    
                    // If it's an array, log field details
                    if (Array.isArray(response) && response.length > 0) {
                        console.log('üìã Fields:');
                        response.forEach((field, index) => {
                            console.log(`   ${index + 1}. ${field.Name} (${field.FieldName})`);
                            console.log(`      - Field ID: ${field.Id}`);
                            console.log(`      - Field Key: ${field.Key}`);
                            console.log(`      - Field Type: ${field.FieldType}`);
                            console.log(`      - General Type: ${field.GeneralType}`);
                            console.log(`      - Is Formula: ${field.IsFormula}`);
                            console.log(`      - Is Relation: ${field.IsRelation}`);
                            
                            // Log enum values if present
                            if (field.Values && field.Values.length > 0) {
                                console.log(`      - Enum Values: ${field.Values.map(v => v.Value).join(', ')}`);
                            }
                            
                            // Log formula if present
                            if (field.Formula) {
                                console.log(`      - Formula: ${field.Formula}`);
                            }
                        });
                    }
                    
                    displayTableFieldsResponse(200, 'OK', response, fieldCount);
                    
                    // Re-enable button
                    $('#testTableFieldsBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Get Fields');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå API Error:', error);
                    console.error('Response:', xhr.responseText);
                    
                    let errorResponse = xhr.responseText;
                    try {
                        errorResponse = JSON.parse(xhr.responseText);
                    } catch (e) {
                        // Keep as string if not JSON
                    }
                    
                    displayTableFieldsResponse(xhr.status, error, errorResponse, 0);
                    
                    // Re-enable button
                    $('#testTableFieldsBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Get Fields');
                }
            });
        }

        /**
         * Display Table Fields API response
         */
        function displayTableFieldsResponse(statusCode, statusText, responseData, fieldCount) {
            // Update status badge
            const statusBadgeClass = statusCode >= 200 && statusCode < 300 ? 'bg-success' : 'bg-danger';
            $('#tableFieldsResponseStatus').removeClass('bg-success bg-danger').addClass(statusBadgeClass).text(`${statusCode} ${statusText}`);
            
            // Update field count
            $('#tableFieldsCount').text(fieldCount);
            
            // Format and display response body
            const formattedResponse = JSON.stringify(responseData, null, 2);
            $('#tableFieldsResponseBody').text(formattedResponse);
            
            // Show response section
            $('#tableFieldsResponseSection').removeClass('hidden');
        }

        /**
         * Load sample field payload
         */
        function loadSampleFieldPayload() {
            const tableKey = $('#createFieldTableKey').val().trim() || 'YOUR_TABLE_KEY_HERE';
            
            const samplePayload = {
                "Name": "First Name",
                "FieldType": "VARCHAR(255)",
                "ApplicationTableKey": tableKey,
                "IsUnique": false,
                "IsNullable": false,
                "IsExternalUrl": false,
                "IsHtmlAllowed": false,
                "IsFlyAdditionAllowed": false,
                "IsAlphaSort": false,
                "onGroupingSummaryType": null,
                "Values": [],
                "Formula": "",
                "EvalFormula": null,
                "IsFormula": false,
                "FormulaFields": null,
                "FieldSize": 100,
                "Key": null,
                "PIILength": null,
                "PIIDirection": null,
                "LinkText": null,
                "EnableDoc": false,
                "IsUrl": false,
                "IsHtml": false
            };
            
            $('#createFieldPayload').val(JSON.stringify(samplePayload, null, 2));
            console.log('üìù Loaded sample field payload');
        }

        /**
         * Test POST /api/Field endpoint
         */
        function testCreateField() {
            const tableKey = $('#createFieldTableKey').val().trim();
            const payloadText = $('#createFieldPayload').val().trim();
            
            if (!tableKey) {
                alert('Please enter a Target Table Key');
                return;
            }
            
            if (!payloadText) {
                alert('Please enter a field payload JSON');
                return;
            }

            // Parse and validate JSON
            let payload;
            try {
                payload = JSON.parse(payloadText);
            } catch (e) {
                alert('Invalid JSON payload: ' + e.message);
                return;
            }

            // Ensure ApplicationTableKey matches the input
            payload.ApplicationTableKey = tableKey;

            console.log('üß™ Testing POST /api/Field');
            console.log('üì§ Payload:', payload);

            // Disable button and show loading state
            $('#testCreateFieldBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Creating...');
            $('#createFieldResponseSection').addClass('hidden');

            $.ajax({
                url: SERVER_URL_PAGE + '/api/Field',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + userToken);
                },
                success: function(response) {
                    console.log('‚úÖ Field Created Successfully:', response);
                    console.log(`   ‚úì Field Name: ${response.Name || payload.Name}`);
                    console.log(`   ‚úì Field Type: ${response.FieldType || payload.FieldType}`);
                    console.log(`   ‚úì Field ID: ${response.Id || 'N/A'}`);
                    console.log(`   ‚úì Field Key: ${response.Key || 'N/A'}`);
                    
                    displayCreateFieldResponse(200, 'OK', response);
                    
                    // Re-enable button
                    $('#testCreateFieldBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Create Field');
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå API Error:', error);
                    console.error('Response:', xhr.responseText);
                    
                    let errorResponse = xhr.responseText;
                    try {
                        errorResponse = JSON.parse(xhr.responseText);
                    } catch (e) {
                        // Keep as string if not JSON
                    }
                    
                    displayCreateFieldResponse(xhr.status, error, errorResponse);
                    
                    // Re-enable button
                    $('#testCreateFieldBtn').prop('disabled', false).html('<i class="bi bi-play-circle me-1"></i>Create Field');
                }
            });
        }

        /**
         * Display Create Field API response
         */
        function displayCreateFieldResponse(statusCode, statusText, responseData) {
            // Update status badge
            const statusBadgeClass = statusCode >= 200 && statusCode < 300 ? 'bg-success' : 'bg-danger';
            $('#createFieldResponseStatus').removeClass('bg-success bg-danger').addClass(statusBadgeClass).text(`${statusCode} ${statusText}`);
            
            // Format and display response body
            const formattedResponse = JSON.stringify(responseData, null, 2);
            $('#createFieldResponseBody').text(formattedResponse);
            
            // Show response section
            $('#createFieldResponseSection').removeClass('hidden');
        }
    </script>
</body>
</html>

